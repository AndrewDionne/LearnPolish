<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Listening ‚Ä¢ Path to POLISH</title>
  <style>
    :root{
      --brand:#2d6cdf;
      --bg:#0b0c10; --card:#121418; --text:#e9ecf1; --muted:#8b94a7; --accent:#2d6cdf; --good:#2dcf6c; --bad:#ff5a5f;
      --pad:16px; --radius:14px; --shadow:0 8px 24px rgba(0,0,0,.25);
      --border:#1e2230;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f7f7fb; --card:#ffffff; --text:#0c0f14; --muted:#5a6472; --shadow:0 8px 24px rgba(0,0,0,.08); --border:#e6e6ef; }
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,system-ui,sans-serif;}

    /* Global site header with gold bar */
    .site-header{position:sticky;top:0;z-index:20;background:var(--card);border-bottom:1px solid var(--border)}
    .site-header .row{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 14px}
    .brand{font-weight:800;letter-spacing:.2px}
    .gold-wrap{display:flex;align-items:center;gap:8px}
    .goldbar{width:140px;height:8px;border-radius:999px;background:rgba(45,108,223,.15);overflow:hidden}
    .goldbar .fill{height:100%;width:0;border-radius:999px;background:#2d6cdf;transition:width .25s ease}
    .gold-label{font-size:12px;opacity:.8}

    /* Page header */
    header.page{position:sticky;top:58px;background:var(--bg);padding:12px var(--pad);display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(128,128,128,.15);z-index:10;}
    .title{font-weight:700;}
    .pill{font-size:.9rem;color:var(--muted);}

    .wrap{max-width:900px;margin:0 auto;padding:var(--pad);}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;margin:16px 0;border:1px solid var(--border);}

    .player{display:flex;gap:12px;align-items:center;}
    button{appearance:none;border:0;background:var(--accent);color:white;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer;}
    button.ghost{background:transparent;color:var(--text);border:1px solid var(--border);}
    button[disabled]{opacity:.5;cursor:not-allowed;}

    .speed-btn{border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700}
    .speed-btn.active{background:rgba(45,108,223,.12);color:#2d6cdf;border-color:transparent}

    .play-btn.replay::before{content:"‚Üª ";}

    .meta{display:flex;gap:12px;align-items:center;color:var(--muted);font-size:.95rem;}
    .choices{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px;}
    .choice{background:#1a1f27;border:1px solid var(--border);padding:12px;border-radius:12px;text-align:left}
    @media (prefers-color-scheme: light){ .choice{background:#fff;} }
    .choice.correct{outline:2px solid var(--good);}
    .choice.wrong{outline:2px solid var(--bad);}

    .section-title{font-weight:700;margin:0 0 6px;}
    .tr{white-space:pre-wrap;color:var(--muted);}

    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:8px;gap:10px;flex-wrap:wrap;}
    .tag{background:rgba(128,128,128,.15);color:var(--text);border-radius:999px;padding:6px 10px;font-size:.85rem;}

    .hidden{display:none;}

    /* Bottom nav (shared style) */
    nav.bottom{position:fixed;left:0;right:0;bottom:0;background:var(--card);border-top:1px solid var(--border);display:flex;justify-content:space-around;padding:6px 8px;gap:8px;z-index:30}
    nav.bottom a{flex:1;text-align:center;padding:8px;text-decoration:none;color:var(--text);border-radius:10px;display:flex;flex-direction:column;align-items:center;gap:4px;font-size:12px}
    nav.bottom a svg{width:20px;height:20px}
    nav.bottom a.active{background:rgba(45,108,223,.12);color:var(--brand)}
    @supports(padding:max(0px)){ nav.bottom{ padding-bottom:max(6px, env(safe-area-inset-bottom)) } }
  </style>
</head>
<body>

  <!-- Global header with gold bar -->
  <div class="site-header">
    <div class="row">
      <div class="brand">Path to POLISH</div>
      <div class="gold-wrap">
        <div class="goldbar"><div id="goldFill" class="fill"></div></div>
        <span id="goldLabel" class="gold-label">0 / 500</span>
      </div>
    </div>
  </div>

  <!-- Page header (kept) -->
  <header class="page">
    <div class="title">üéß Listening</div>
    <div class="pill"><span id="gold">0</span> gold ‚Ä¢ <span id="progress">0/0</span></div>
  </header>

  <main class="wrap">

    <!-- Player + meta -->
    <div class="card">
      <div class="meta"><span id="countLabel"></span><span id="lengthLabel"></span><span id="replayLabel"></span></div>
      <div class="player" style="margin-top:8px;">
        <button id="playBtn" class="play-btn" type="button">Play</button>
        <button id="speedBtn" class="speed-btn" type="button" aria-pressed="false" title="Toggle 0.75√ó">0.75√ó</button>
        <audio id="audio" preload="auto" controlslist="nodownload noplaybackrate"></audio>
      </div>
    </div>

    <!-- Gist -->
    <div class="card" id="gistCard" aria-live="polite">
      <div class="section-title">Gist</div>
      <div id="gistPrompt"></div>
      <div class="choices" id="gistChoices"></div>
    </div>

    <!-- Details -->
    <div class="card" id="detailCard" aria-live="polite">
      <div class="section-title">Details</div>
      <div id="detailPrompt"></div>
      <div class="choices" id="detailChoices"></div>
    </div>

    <!-- Reveal -->
    <div class="card" id="revealCard">
      <div class="section-title">Transcript</div>
      <div class="tr" id="plText"></div>
      <div style="height:6px"></div>
      <div class="section-title">English</div>
      <div class="tr" id="enText"></div>
    </div>

    <!-- Footer actions (difficulty is gated off by default) -->
    <div class="footer" id="feedbackStrip" style="display:none">
      <div class="tag">Rate difficulty:</div>
      <div class="row" style="gap:6px;">
        <button class="ghost" id="rEasy">Too easy</button>
        <button class="ghost" id="rOk">Just right</button>
        <button class="ghost" id="rHard">Too hard</button>
      </div>
      <div class="row">
        <button id="nextBtn" disabled>Next ‚ñ∂</button>
      </div>
    </div>

    <!-- Summary -->
    <div class="card" id="summaryCard">
      <div class="section-title">Session Summary</div>
      <div id="summaryBody"></div>
      <div class="row" style="margin-top:10px;">
        <button id="restartBtn" class="ghost">Restart</button>
        <button id="toHomeBtn">Done</button>
      </div>
    </div>

  </main>

  <!-- Bottom nav -->
  <nav class="bottom">
    <a id="navHome">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 10.5L12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1v-10.5Z" stroke-width="1.5"/></svg>
      <span>Home</span>
    </a>
    <a id="navLearn" class="active" aria-current="page">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 6h16M4 12h16M4 18h9" stroke-width="1.5" stroke-linecap="round"/></svg>
      <span>Learn</span>
    </a>
    <a id="navLibrary">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="4" width="18" height="16" rx="2" ry="2" stroke-width="1.5"/><path d="M7 8h10M7 12h10M7 16h7" stroke-width="1.5" stroke-linecap="round"/></svg>
      <span>Library</span>
    </a>
    <a id="navDashboard">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 14h6V4H4v10Zm10 6h6V4h-6v16Z" stroke-width="1.5"/></svg>
      <span>Dashboard</span>
    </a>
    <a id="navGroups">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="8" cy="8" r="3" stroke-width="1.5"/><path d="M2 20v-1c0-3 3-5 6-5" stroke-width="1.5" stroke-linecap="round"/><circle cx="16" cy="10" r="3" stroke-width="1.5"/><path d="M11 20v-1c0-2.5 2.5-4.5 5-5" stroke-width="1.5" stroke-linecap="round"/></svg>
      <span>Groups</span>
    </a>
  </nav>

  <script>
  // ‚Äî‚Äî‚Äî‚Äî‚Äî Config ‚Äî‚Äî‚Äî‚Äî‚Äî
  const CONFIG = {
    sessionBonus: 20,
    basePerDialogue: 10,
    lengthBonusEverySec: 20, // +1 per 20s
    lengthBonusCap: 5,
    slowCost: 2,
    replayCost: 1,
    wrongCost: 1,
    replayMax: 3,
    weightGist: 0.4,
    weightDetail: 0.6,
    triesPerQuestion: 3,
  };

  // ‚Äî‚Äî‚Äî‚Äî‚Äî Sample dialogues (replace with your generated set) ‚Äî‚Äî‚Äî‚Äî‚Äî
  const DIALOGUES = [
    {
      id: "d001",
      audio: "audio/d001.mp3",
      duration_s: 0,
      transcript_pl: "ZMIANA! Do ≈Çawki, szybko!",
      translation_en: "Change! To the bench, quick!",
      gist: {
        prompt: "Which best matches the audio?",
        correct: "Change! To the bench, quick!",
        distractors: ["Get back! Mark your man!", "Directions", "An apology"]
      },
      detail: {
        prompt: "What exactly did you hear (in Polish)?",
        correct: "ZMIANA! Do ≈Çawki, szybko!",
        distractor_bank: ["Wracaj! Kryj swojego!"]
      }
    },
    {
      id: "d002",
      audio: "audio/d002.mp3",
      duration_s: 0,
      transcript_pl: "Wracaj! Kryj swojego!",
      translation_en: "Get back! Mark your man!",
      gist: {
        prompt: "Which best matches the audio?",
        correct: "Get back! Mark your man!",
        distractors: ["Change! To the bench, quick!", "Directions", "Small talk"]
      },
      detail: {
        prompt: "What exactly did you hear (in Polish)?",
        correct: "Wracaj! Kryj swojego!",
        distractor_bank: ["ZMIANA! Do ≈Çawki, szybko!"]
      }
    }
  ];

  // ‚Äî‚Äî‚Äî‚Äî‚Äî State ‚Äî‚Äî‚Äî‚Äî‚Äî
  const state = {
    i: 0,
    gold: 0,
    usedSlow: false,
    replays: 0,
    wrongGist: 0,
    wrongDetail: 0,
    answeredGist: false,
    answeredDetail: false,
    gistTriesLeft: CONFIG.triesPerQuestion,
    detailTriesLeft: CONFIG.triesPerQuestion,
    currentDurationS: 0,
    perDialogueLog: [],
    started: false,
  };

  // ‚Äî‚Äî‚Äî‚Äî‚Äî DOM ‚Äî‚Äî‚Äî‚Äî‚Äî
  const $ = (id) => document.getElementById(id);
  const playBtn = $("playBtn");
  const speedBtn = $("speedBtn");
  const nextBtn = $("nextBtn");
  const toHomeBtn = $("toHomeBtn");
  const restartBtn = $("restartBtn");
  const audioEl = $("audio");

  const gistCard = $("gistCard");
  const gistPrompt = $("gistPrompt");
  const gistChoices = $("gistChoices");

  const detailCard = $("detailCard");
  const detailPrompt = $("detailPrompt");
  const detailChoices = $("detailChoices");

  const revealCard = $("revealCard");
  const plText = $("plText");
  const enText = $("enText");

  const summaryCard = $("summaryCard");
  const summaryBody = $("summaryBody");

  const goldLbl = $("gold");
  const progressLbl = $("progress");
  const countLabel = $("countLabel");
  const lengthLabel = $("lengthLabel");
  const replayLabel = $("replayLabel");

  // ‚Äî‚Äî‚Äî‚Äî‚Äî Helpers ‚Äî‚Äî‚Äî‚Äî‚Äî
  function repoBase() {
    const parts = location.pathname.split("/").filter(Boolean);
    if (location.hostname.includes("github.io")) return "/" + parts[0];
    return "";
  }

  function setBottomNav(){
    const base = repoBase();
    $("navHome").href      = base + "/index.html";
    $("navLearn").href     = base + "/learn.html";
    $("navLibrary").href   = base + "/manage_sets/";
    $("navDashboard").href = base + "/dashboard.html";
    $("navGroups").href    = base + "/groups.html";
  }

  function gotoHome() {
    const base = repoBase();
    location.href = base + "/index.html";
  }

  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }
  function sampleDetailChoices(item) {
    const bank = (item.detail?.distractor_bank || []).slice();
    const correct = item.detail?.correct ?? "";
    const pruned = bank.filter(x => x !== correct);
    shuffle(pruned);
    const three = pruned.slice(0, 3);
    const combined = [correct, ...three];
    return shuffle(combined);
  }
  function mcqText(opt){
    if (typeof opt === 'string') return opt.trim();
    if (!opt || typeof opt !== 'object') return '';
    return String(
      opt.gist || opt.detail || opt.phrase || opt.polish || opt.meaning || opt.english || ''
    ).trim();
  }

  function computePool(item, usedSlow, replays, wrongGist, wrongDetail) {
    const base = CONFIG.basePerDialogue;
    const dur = (item.duration_s || state.currentDurationS || 0);
    const lenBonus = Math.min(CONFIG.lengthBonusCap, Math.floor(dur / CONFIG.lengthBonusEverySec));
    let pool = base + lenBonus;
    // Global penalties
    pool -= (usedSlow ? CONFIG.slowCost : 0);
    pool -= (replays * CONFIG.replayCost);
    if (pool < 0) pool = 0;
    // Shares
    const gShare = pool * CONFIG.weightGist;
    const dShare = pool * CONFIG.weightDetail;
    const gEarn = Math.max(0, Math.floor(gShare - wrongGist * CONFIG.wrongCost));
    const dEarn = Math.max(0, Math.floor(dShare - wrongDetail * CONFIG.wrongCost));
    return Math.max(0, gEarn + dEarn);
  }

  function setHidden(el, hidden=true) { el.classList.toggle("hidden", hidden); }
  function resetQuestionUI() {
    gistChoices.innerHTML = ""; detailChoices.innerHTML = "";
    [gistCard, detailCard, revealCard, summaryCard].forEach(el => setHidden(el, true));
    if (nextBtn) nextBtn.disabled = true;
  }

  function setHeader() {
    goldLbl.textContent = state.gold;
    progressLbl.textContent = `${state.i+1}/${DIALOGUES.length}`;
    countLabel.textContent = `Dialog ${state.i+1} of ${DIALOGUES.length}`;
    const dur = (DIALOGUES[state.i]?.duration_s || state.currentDurationS || 0);
    lengthLabel.textContent = dur ? `‚Ä¢ ${dur}s` : "";
    replayLabel.textContent = `‚Ä¢ Replays left: ${Math.max(0, CONFIG.replayMax - state.replays)}`;
  }

  function beginSessionIfNeeded() {
    if (!state.started) {
      state.gold += CONFIG.sessionBonus;
      state.started = true;
      goldLbl.textContent = state.gold;
    }
  }

  function loadAudio(item) {
    const src = item.audio || item.audio_url || "";
    audioEl.src = src;
    audioEl.playbackRate = 1.0;
  }

  function renderGist(item) {
    if (!item.gist) return;
    setHidden(gistCard, false);
    gistPrompt.textContent = item.gist.prompt || "Which best matches the audio?";
    const correct = item.gist.correct;
    const opts = shuffle([ correct, ...(item.gist.distractors || []).slice(0,3) ]);
    gistChoices.innerHTML = "";
    opts.forEach((opt) => {
      const txt = mcqText(opt) || "‚Äî";
      const b = document.createElement("button");
      b.className = "choice"; b.textContent = txt;
      b.onclick = () => onGistAnswer(item, b, txt === mcqText(correct));
      gistChoices.appendChild(b);
    });
  }

  function renderDetail(item) {
    if (!item.detail) return;
    setHidden(detailCard, false);
    detailPrompt.textContent = item.detail.prompt || "What detail did you hear?";
    const opts = sampleDetailChoices(item);
    detailChoices.innerHTML = "";
    opts.forEach((txt) => {
      const b = document.createElement("button");
      b.className = "choice";
      b.textContent = mcqText(txt) || "‚Äî";
      b.onclick = () => onDetailAnswer(item, b, txt === item.detail.correct);
      detailChoices.appendChild(b);
    });
  }

  function renderReveal(item) {
    plText.textContent = item.transcript_pl || "(no transcript)";
    enText.textContent = item.translation_en || "";
    setHidden(revealCard, false);
  }

  function lockChoices(containerId) {
    const children = document.getElementById(containerId).children;
    for (const c of children) c.disabled = true;
  }

  function onGistAnswer(item, btn, correct) {
    if (state.answeredGist) return;
    if (correct) {
      btn.classList.add("correct");
      state.answeredGist = true;
      lockChoices("gistChoices");
      if (!state.answeredDetail) renderDetail(item);
      if (state.answeredDetail) finalizeDialogue(item);
      return;
    }
    btn.classList.add("wrong");
    btn.disabled = true;
    state.wrongGist++;
    state.gistTriesLeft--;
    if (state.gistTriesLeft <= 0) {
      state.answeredGist = true;
      [...gistChoices.children].forEach(c => {
        if (c.textContent === (mcqText(item.gist?.correct) || "")) c.classList.add("correct");
        c.disabled = true;
      });
      if (!state.answeredDetail) renderDetail(item);
      if (state.answeredDetail) finalizeDialogue(item);
    }
  }

  function onDetailAnswer(item, btn, correct) {
    if (state.answeredDetail) return;
    if (correct) {
      btn.classList.add("correct");
      state.answeredDetail = true;
      lockChoices("detailChoices");
      if (state.answeredGist) finalizeDialogue(item);
      return;
    }
    btn.classList.add("wrong");
    btn.disabled = true;
    state.wrongDetail++;
    state.detailTriesLeft--;
    if (state.detailTriesLeft <= 0) {
      state.answeredDetail = true;
      [...detailChoices.children].forEach(c => {
        if (c.textContent === (item.detail?.correct || "")) c.classList.add("correct");
        c.disabled = true;
      });
      if (state.answeredGist) finalizeDialogue(item);
    }
  }

  function finalizeDialogue(item) {
    const gained = computePool(item, state.usedSlow, state.replays, state.wrongGist, state.wrongDetail);
    state.gold += gained;
    state.perDialogueLog.push({
      id: item.id || `d${state.i+1}`,
      usedSlow: state.usedSlow,
      replays: state.replays,
      wrongGist: state.wrongGist,
      wrongDetail: state.wrongDetail,
      payout: gained,
      duration_s: item.duration_s || state.currentDurationS || 0,
    });
    goldLbl.textContent = state.gold;
    renderReveal(item);
    if (nextBtn) nextBtn.disabled = false;
  }

  function resetPerDialogue() {
    state.usedSlow = false;
    state.replays = 0;
    state.wrongGist = 0;
    state.wrongDetail = 0;
    state.answeredGist = false;
    state.answeredDetail = false;
    state.gistTriesLeft = CONFIG.triesPerQuestion;
    state.detailTriesLeft = CONFIG.triesPerQuestion;
    state.currentDurationS = 0;
    document.dispatchEvent(new Event('lp:speed-reset'));
    document.dispatchEvent(new Event('lp:dialogue-start'));
  }

  function startDialogue(idx) {
    if (idx >= DIALOGUES.length) return endSession();
    resetPerDialogue(); resetQuestionUI();
    const item = DIALOGUES[idx];
    state.currentDurationS = Math.round(item?.duration_s || 0); // until metadata loads
    setHeader();
    loadAudio(item);
  }

  function endSession() {
    setHidden(gistCard,true); setHidden(detailCard,true); setHidden(revealCard,true);
    setHidden(summaryCard,false);
    const rows = state.perDialogueLog.map((r, k) =>
      `#${k+1} ‚Ä¢ +${r.payout} gold ‚Ä¢ replay:${r.replays} ‚Ä¢ slow:${r.usedSlow?'y':'n'} ‚Ä¢ gist√ó${r.wrongGist} ‚Ä¢ detail√ó${r.wrongDetail}`
    ).join("\n");
    summaryBody.textContent = `Total gold: ${state.gold}\n\n${rows}`;
  }

  // ‚Äî‚Äî‚Äî‚Äî‚Äî Wire Play‚ÜíReplay (counts replays, respects max) ‚Äî‚Äî‚Äî‚Äî‚Äî
  (function wirePlayReplay(){
    const audio = audioEl;
    const btn = playBtn;
    if (!audio || !btn) return;

    let hasPlayed = false;

    function makeReplayUI(){
      btn.classList.add('replay');
      btn.textContent = 'Replay';
      btn.setAttribute('aria-label','Replay');
    }

    btn.addEventListener('click', ()=>{
      if (hasPlayed && state.replays >= CONFIG.replayMax) {
        btn.disabled = true;
        return;
      }
      audio.currentTime = 0;
      audio.play();

      if (!hasPlayed){
        hasPlayed = true;
        makeReplayUI();
      } else {
        state.replays += 1;
        setHeader();
      }
      if (state.replays >= CONFIG.replayMax) btn.disabled = true;
    });

    audio.addEventListener('ended', ()=>{
      if (!hasPlayed){ hasPlayed = true; makeReplayUI(); }
    });

    document.addEventListener('lp:dialogue-start', ()=>{
      hasPlayed = false;
      btn.disabled = false;
      btn.classList.remove('replay');
      btn.textContent = 'Play';
      btn.setAttribute('aria-label','Play');
    });
  })();

  // ‚Äî‚Äî‚Äî‚Äî‚Äî Wire Speed toggle (blue active, on/off) ‚Äî‚Äî‚Äî‚Äî‚Äî
  (function wireSpeed(){
    const audio = audioEl;
    const btn = speedBtn;
    if (!audio || !btn) return;

    let slow = false;

    function apply(){
      audio.playbackRate = slow ? 0.75 : 1.0;
      btn.classList.toggle('active', slow);
      btn.setAttribute('aria-pressed', slow ? 'true' : 'false');
      btn.textContent = slow ? '0.75√ó' : '1.0√ó';
      btn.title = slow ? 'Back to 1.0√ó' : 'Switch to 0.75√ó';
    }

    btn.addEventListener('click', ()=>{
      slow = !slow;
      if (slow && !state.usedSlow) state.usedSlow = true; // charge once per dialogue
      apply();
    });

    document.addEventListener('lp:speed-reset', ()=>{
      slow = false; apply();
    });

    apply();
  })();

  // ‚Äî‚Äî‚Äî‚Äî‚Äî Events ‚Äî‚Äî‚Äî‚Äî‚Äî
  playBtn.onclick = () => { beginSessionIfNeeded(); audioEl.play().catch(()=>{}); };
  nextBtn && (nextBtn.onclick = () => { state.i++; if (state.i >= DIALOGUES.length) endSession(); else startDialogue(state.i); });
  restartBtn.onclick = () => window.location.reload();
  toHomeBtn.onclick = gotoHome;

  $("rEasy").onclick = () => console.log("rated: easy", DIALOGUES[state.i]?.id);
  $("rOk").onclick   = () => console.log("rated: ok", DIALOGUES[state.i]?.id);
  $("rHard").onclick = () => console.log("rated: hard", DIALOGUES[state.i]?.id);

  audioEl.addEventListener('ended', () => {
    const item = DIALOGUES[state.i];
    renderGist(item);
  });

  audioEl.addEventListener('loadedmetadata', () => {
    const d = isFinite(audioEl.duration) ? Math.round(audioEl.duration) : 0;
    if (d > 0) state.currentDurationS = d;
    setHeader();
  });

  // ‚Äî‚Äî‚Äî‚Äî‚Äî Init ‚Äî‚Äî‚Äî‚Äî‚Äî
  (function init() {
    setBottomNav();
    if (!Array.isArray(DIALOGUES) || DIALOGUES.length === 0) {
      document.body.innerHTML = '<div style="padding:20px;font-family:sans-serif;">‚ö†Ô∏è No dialogues found for this set.</div>';
      return;
    }
    setHidden(gistCard,true); setHidden(detailCard,true); setHidden(revealCard,true); setHidden(summaryCard,true);
    state.gold = 0;
    startDialogue(0);
  })();

  // ‚Äî‚Äî‚Äî‚Äî‚Äî Gold bar ‚Äî‚Äî‚Äî‚Äî‚Äî
  (async function wireGold(){
    try{
      const token = localStorage.getItem('lp_token') || '';
      const r = await fetch('/api/my/stats', { headers: { Authorization: 'Bearer '+token }});
      if(!r.ok) return;
      const s = await r.json();
      const got = Number(s.weekly_gold || s.weekly_points || 0);
      const goal = Number(s.goal_gold || s.goal_points || 500) || 500;
      const pct = Math.max(0, Math.min(100, Math.round((got/goal)*100)));
      const fill = document.getElementById('goldFill');
      const lab  = document.getElementById('goldLabel');
      if (fill) fill.style.width = pct + '%';
      if (lab)  lab.textContent = `${got} / ${goal}`;
    }catch(_){}
  })();

  // ‚Äî‚Äî‚Äî‚Äî‚Äî Feedback gate (enable via ?feedback=1, localStorage lp_feedback=on, or window.IS_ADMIN=true) ‚Äî‚Äî‚Äî‚Äî‚Äî
  (function feedbackGate(){
    const on = new URL(location.href).searchParams.get('feedback') === '1'
            || localStorage.getItem('lp_feedback') === 'on'
            || window.IS_ADMIN === true;
    const el = document.getElementById('feedbackStrip');
    if (el) el.style.display = on ? 'flex' : 'none';
  })();
  </script>
</body>
</html>
