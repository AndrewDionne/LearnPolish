<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hockey 5 ‚Ä¢ Listening Mode</title>
  <style>
    :root{
      --bg:#0b0c10; --card:#121418; --text:#e9ecf1; --muted:#8b94a7; --accent:#2d6cdf; --good:#2dcf6c; --bad:#ff5a5f;
      --pad:16px; --radius:14px; --shadow:0 8px 24px rgba(0,0,0,.25);
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f7f7fb; --card:#ffffff; --text:#0c0f14; --muted:#5a6472; --shadow:0 8px 24px rgba(0,0,0,.08); }
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Inter,system-ui,sans-serif;}
    header{position:sticky;top:0;background:var(--bg);padding:12px var(--pad);display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(128,128,128,.15);z-index:10;}
    .title{font-weight:700;}
    .pill{font-size:.9rem;color:var(--muted);}
    .wrap{max-width:900px;margin:0 auto;padding:var(--pad);}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px;margin:16px 0;}
    .player{display:flex;gap:12px;align-items:center;}
    button{appearance:none;border:0;background:var(--accent);color:white;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer;}
    button.ghost{background:transparent;color:var(--text);border:1px solid rgba(128,128,128,.3);}
    button[disabled]{opacity:.5;cursor:not-allowed;}
    .choices{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px;}
    .choice{background:#1a1f27;border:1px solid rgba(128,128,128,.25);padding:12px;border-radius:12px;}
    @media (prefers-color-scheme: light){ .choice{background:#fff;} }
    .choice.correct{outline:2px solid var(--good);}
    .choice.wrong{outline:2px solid var(--bad);}
    .meta{display:flex;gap:12px;align-items:center;color:var(--muted);font-size:.95rem;}
    .section-title{font-weight:700;margin:0 0 6px;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
    .grow{flex:1;}
    .hidden{display:none;}
    .tr{white-space:pre-wrap;color:var(--muted);}
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:8px;}
    .tag{background:rgba(128,128,128,.15);color:var(--text);border-radius:999px;padding:6px 10px;font-size:.85rem;}
  </style>
</head>
<body>
  <header class="wrap">
    <div class="title">üéß Listening ‚Ä¢ Hockey 5</div>
    <div class="pill"><span id="gold">0</span> gold ‚Ä¢ <span id="progress">0/0</span></div>
  </header>

  <main class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="meta"><span id="countLabel"></span><span id="lengthLabel"></span><span id="replayLabel"></span></div>
        <div class="row"><button class="ghost" id="homeBtn">üè† Home</button></div>
      </div>
      <div class="player" style="margin-top:8px;">
        <button id="playBtn">‚ñ∂Ô∏è Play</button>
        <button class="ghost" id="speedBtn">0.75√ó</button>
        <button class="ghost" id="replayBtn">Replay (3)</button>
        <audio id="audio" preload="auto"></audio>
      </div>
    </div>

    <div class="card" id="gistCard" aria-live="polite">
      <div class="section-title">Gist</div>
      <div id="gistPrompt"></div>
      <div class="choices" id="gistChoices"></div>
    </div>

    <div class="card" id="detailCard" aria-live="polite">
      <div class="section-title">Details</div>
      <div id="detailPrompt"></div>
      <div class="choices" id="detailChoices"></div>
    </div>

    <div class="card" id="revealCard">
      <div class="section-title">Transcript</div>
      <div class="tr" id="plText"></div>
      <div style="height:6px"></div>
      <div class="section-title">English</div>
      <div class="tr" id="enText"></div>
    </div>

    <div class="footer">
      <div class="row" style="gap:6px;">
        <span class="tag">Rate difficulty:</span>
        <button class="ghost" id="rEasy">Too easy</button>
        <button class="ghost" id="rOk">Just right</button>
        <button class="ghost" id="rHard">Too hard</button>
      </div>
      <div class="row">
        <button id="nextBtn" disabled>Next ‚ñ∂</button>
      </div>
    </div>

    <div class="card" id="summaryCard">
      <div class="section-title">Session Summary</div>
      <div id="summaryBody"></div>
      <div class="row" style="margin-top:10px;">
        <button id="restartBtn" class="ghost">Restart</button>
        <button id="toHomeBtn">Done</button>
      </div>
    </div>
  </main>

  <script>
  // ‚Äî‚Äî‚Äî‚Äî‚Äî Config (tweak without touching Python) ‚Äî‚Äî‚Äî‚Äî‚Äî
  const CONFIG = {
    sessionBonus: 20,
    basePerDialogue: 10,
    lengthBonusEverySec: 20, // +1 per 20s
    lengthBonusCap: 5,
    slowCost: 2,
    replayCost: 1,
    wrongCost: 1,
    replayMax: 3,
    weightGist: 0.4,
    weightDetail: 0.6,
    triesPerQuestion: 3,
  };

  const SET_NAME = "Hockey 5";
  const DIALOGUES = [{"id": "d001", "audio": "listening/d001.mp3", "duration_s": 0, "transcript_pl": "Na lodowisku gra po sze≈õciu zawodnik√≥w z ka≈ºdej dru≈ºyny, w tym bramkarz.", "translation_en": "There are six players on the ice per team, including the goalie.", "gist": {"prompt": "Which best matches the audio?", "correct": "There are six players on the ice per team, including the goalie.", "distractors": ["The defenseman blocked the slap shot.", "The forward ripped a strong wrist shot into the top corner.", "We're on the power play after the opponent's penalty."]}, "detail": {"prompt": "What exactly did you hear (in Polish)?", "correct": "Na lodowisku gra po sze≈õciu zawodnik√≥w z ka≈ºdej dru≈ºyny, w tym bramkarz.", "distractor_bank": ["Bramkarz obroni≈Ç strza≈Ç parkanami.", "Sƒôdzia odgwizda≈Ç spalonego na niebieskiej linii.", "Trener poprosi≈Ç o czas, ≈ºeby ustawiƒá ostatniƒÖ zmianƒô.", "Gramy w przewadze po karze przeciwnika.", "Obro≈Ñca zablokowa≈Ç uderzenie z klepy.", "Dostali≈õmy dwie minuty kary za zahaczanie.", "KrƒÖ≈ºek wpad≈Ç do bramki po dobitce napastnika.", "Uda≈Ço nam siƒô utrzymaƒá prowadzenie dziƒôki dobrej obronie w os≈Çabieniu.", "Napastnik odda≈Ç mocny strza≈Ç z nadgarstka w okienko."]}}, {"id": "d002", "audio": "listening/d002.mp3", "duration_s": 0, "transcript_pl": "KrƒÖ≈ºek wpad≈Ç do bramki po dobitce napastnika.", "translation_en": "The puck went into the net on the forward's rebound.", "gist": {"prompt": "Which best matches the audio?", "correct": "The puck went into the net on the forward's rebound.", "distractors": ["The defenseman blocked the slap shot.", "The coach called a timeout to set up the last shift.", "The goalie made a pad save."]}, "detail": {"prompt": "What exactly did you hear (in Polish)?", "correct": "KrƒÖ≈ºek wpad≈Ç do bramki po dobitce napastnika.", "distractor_bank": ["Na lodowisku gra po sze≈õciu zawodnik√≥w z ka≈ºdej dru≈ºyny, w tym bramkarz.", "Sƒôdzia odgwizda≈Ç spalonego na niebieskiej linii.", "Napastnik odda≈Ç mocny strza≈Ç z nadgarstka w okienko.", "Dostali≈õmy dwie minuty kary za zahaczanie.", "Bramkarz obroni≈Ç strza≈Ç parkanami.", "Trener poprosi≈Ç o czas, ≈ºeby ustawiƒá ostatniƒÖ zmianƒô.", "Obro≈Ñca zablokowa≈Ç uderzenie z klepy.", "Uda≈Ço nam siƒô utrzymaƒá prowadzenie dziƒôki dobrej obronie w os≈Çabieniu.", "Gramy w przewadze po karze przeciwnika."]}}, {"id": "d003", "audio": "listening/d003.mp3", "duration_s": 0, "transcript_pl": "Dostali≈õmy dwie minuty kary za zahaczanie.", "translation_en": "We got a two-minute penalty for hooking.", "gist": {"prompt": "Which best matches the audio?", "correct": "We got a two-minute penalty for hooking.", "distractors": ["The coach called a timeout to set up the last shift.", "The puck went into the net on the forward's rebound.", "The goalie made a pad save."]}, "detail": {"prompt": "What exactly did you hear (in Polish)?", "correct": "Dostali≈õmy dwie minuty kary za zahaczanie.", "distractor_bank": ["Bramkarz obroni≈Ç strza≈Ç parkanami.", "Trener poprosi≈Ç o czas, ≈ºeby ustawiƒá ostatniƒÖ zmianƒô.", "Sƒôdzia odgwizda≈Ç spalonego na niebieskiej linii.", "Gramy w przewadze po karze przeciwnika.", "Na lodowisku gra po sze≈õciu zawodnik√≥w z ka≈ºdej dru≈ºyny, w tym bramkarz.", "KrƒÖ≈ºek wpad≈Ç do bramki po dobitce napastnika.", "Obro≈Ñca zablokowa≈Ç uderzenie z klepy.", "Napastnik odda≈Ç mocny strza≈Ç z nadgarstka w okienko.", "Uda≈Ço nam siƒô utrzymaƒá prowadzenie dziƒôki dobrej obronie w os≈Çabieniu."]}}, {"id": "d004", "audio": "listening/d004.mp3", "duration_s": 0, "transcript_pl": "Sƒôdzia odgwizda≈Ç spalonego na niebieskiej linii.", "translation_en": "The referee called offside at the blue line.", "gist": {"prompt": "Which best matches the audio?", "correct": "The referee called offside at the blue line.", "distractors": ["The forward ripped a strong wrist shot into the top corner.", "We held the lead thanks to a strong penalty kill.", "We got a two-minute penalty for hooking."]}, "detail": {"prompt": "What exactly did you hear (in Polish)?", "correct": "Sƒôdzia odgwizda≈Ç spalonego na niebieskiej linii.", "distractor_bank": ["Bramkarz obroni≈Ç strza≈Ç parkanami.", "KrƒÖ≈ºek wpad≈Ç do bramki po dobitce napastnika.", "Uda≈Ço nam siƒô utrzymaƒá prowadzenie dziƒôki dobrej obronie w os≈Çabieniu.", "Na lodowisku gra po sze≈õciu zawodnik√≥w z ka≈ºdej dru≈ºyny, w tym bramkarz.", "Napastnik odda≈Ç mocny strza≈Ç z nadgarstka w okienko.", "Dostali≈õmy dwie minuty kary za zahaczanie.", "Trener poprosi≈Ç o czas, ≈ºeby ustawiƒá ostatniƒÖ zmianƒô.", "Obro≈Ñca zablokowa≈Ç uderzenie z klepy.", "Gramy w przewadze po karze przeciwnika."]}}, {"id": "d005", "audio": "listening/d005.mp3", "duration_s": 0, "transcript_pl": "Gramy w przewadze po karze przeciwnika.", "translation_en": "We're on the power play after the opponent's penalty.", "gist": {"prompt": "Which best matches the audio?", "correct": "We're on the power play after the opponent's penalty.", "distractors": ["The defenseman blocked the slap shot.", "We got a two-minute penalty for hooking.", "The referee called offside at the blue line."]}, "detail": {"prompt": "What exactly did you hear (in Polish)?", "correct": "Gramy w przewadze po karze przeciwnika.", "distractor_bank": ["Napastnik odda≈Ç mocny strza≈Ç z nadgarstka w okienko.", "Uda≈Ço nam siƒô utrzymaƒá prowadzenie dziƒôki dobrej obronie w os≈Çabieniu.", "Na lodowisku gra po sze≈õciu zawodnik√≥w z ka≈ºdej dru≈ºyny, w tym bramkarz.", "Dostali≈õmy dwie minuty kary za zahaczanie.", "Sƒôdzia odgwizda≈Ç spalonego na niebieskiej linii.", "Obro≈Ñca zablokowa≈Ç uderzenie z klepy.", "Bramkarz obroni≈Ç strza≈Ç parkanami.", "Trener poprosi≈Ç o czas, ≈ºeby ustawiƒá ostatniƒÖ zmianƒô.", "KrƒÖ≈ºek wpad≈Ç do bramki po dobitce napastnika."]}}, {"id": "d006", "audio": "listening/d006.mp3", "duration_s": 0, "transcript_pl": "Bramkarz obroni≈Ç strza≈Ç parkanami.", "translation_en": "The goalie made a pad save.", "gist": {"prompt": "Which best matches the audio?", "correct": "The goalie made a pad save.", "distractors": ["We got a two-minute penalty for hooking.", "The referee called offside at the blue line.", "The coach called a timeout to set up the last shift."]}, "detail": {"prompt": "What exactly did you hear (in Polish)?", "correct": "Bramkarz obroni≈Ç strza≈Ç parkanami.", "distractor_bank": ["Obro≈Ñca zablokowa≈Ç uderzenie z klepy.", "Dostali≈õmy dwie minuty kary za zahaczanie.", "Gramy w przewadze po karze przeciwnika.", "Napastnik odda≈Ç mocny strza≈Ç z nadgarstka w okienko.", "Uda≈Ço nam siƒô utrzymaƒá prowadzenie dziƒôki dobrej obronie w os≈Çabieniu.", "Trener poprosi≈Ç o czas, ≈ºeby ustawiƒá ostatniƒÖ zmianƒô.", "Sƒôdzia odgwizda≈Ç spalonego na niebieskiej linii.", "Na lodowisku gra po sze≈õciu zawodnik√≥w z ka≈ºdej dru≈ºyny, w tym bramkarz.", "KrƒÖ≈ºek wpad≈Ç do bramki po dobitce napastnika."]}}, {"id": "d007", "audio": "listening/d007.mp3", "duration_s": 0, "transcript_pl": "Napastnik odda≈Ç mocny strza≈Ç z nadgarstka w okienko.", "translation_en": "The forward ripped a strong wrist shot into the top corner.", "gist": {"prompt": "Which best matches the audio?", "correct": "The forward ripped a strong wrist shot into the top corner.", "distractors": ["We got a two-minute penalty for hooking.", "There are six players on the ice per team, including the goalie.", "We're on the power play after the opponent's penalty."]}, "detail": {"prompt": "What exactly did you hear (in Polish)?", "correct": "Napastnik odda≈Ç mocny strza≈Ç z nadgarstka w okienko.", "distractor_bank": ["Obro≈Ñca zablokowa≈Ç uderzenie z klepy.", "Na lodowisku gra po sze≈õciu zawodnik√≥w z ka≈ºdej dru≈ºyny, w tym bramkarz.", "Gramy w przewadze po karze przeciwnika.", "Sƒôdzia odgwizda≈Ç spalonego na niebieskiej linii.", "Dostali≈õmy dwie minuty kary za zahaczanie.", "KrƒÖ≈ºek wpad≈Ç do bramki po dobitce napastnika.", "Uda≈Ço nam siƒô utrzymaƒá prowadzenie dziƒôki dobrej obronie w os≈Çabieniu.", "Trener poprosi≈Ç o czas, ≈ºeby ustawiƒá ostatniƒÖ zmianƒô.", "Bramkarz obroni≈Ç strza≈Ç parkanami."]}}, {"id": "d008", "audio": "listening/d008.mp3", "duration_s": 0, "transcript_pl": "Obro≈Ñca zablokowa≈Ç uderzenie z klepy.", "translation_en": "The defenseman blocked the slap shot.", "gist": {"prompt": "Which best matches the audio?", "correct": "The defenseman blocked the slap shot.", "distractors": ["We got a two-minute penalty for hooking.", "The goalie made a pad save.", "The puck went into the net on the forward's rebound."]}, "detail": {"prompt": "What exactly did you hear (in Polish)?", "correct": "Obro≈Ñca zablokowa≈Ç uderzenie z klepy.", "distractor_bank": ["Trener poprosi≈Ç o czas, ≈ºeby ustawiƒá ostatniƒÖ zmianƒô.", "Gramy w przewadze po karze przeciwnika.", "Sƒôdzia odgwizda≈Ç spalonego na niebieskiej linii.", "KrƒÖ≈ºek wpad≈Ç do bramki po dobitce napastnika.", "Uda≈Ço nam siƒô utrzymaƒá prowadzenie dziƒôki dobrej obronie w os≈Çabieniu.", "Napastnik odda≈Ç mocny strza≈Ç z nadgarstka w okienko.", "Na lodowisku gra po sze≈õciu zawodnik√≥w z ka≈ºdej dru≈ºyny, w tym bramkarz.", "Bramkarz obroni≈Ç strza≈Ç parkanami.", "Dostali≈õmy dwie minuty kary za zahaczanie."]}}, {"id": "d009", "audio": "listening/d009.mp3", "duration_s": 0, "transcript_pl": "Uda≈Ço nam siƒô utrzymaƒá prowadzenie dziƒôki dobrej obronie w os≈Çabieniu.", "translation_en": "We held the lead thanks to a strong penalty kill.", "gist": {"prompt": "Which best matches the audio?", "correct": "We held the lead thanks to a strong penalty kill.", "distractors": ["We're on the power play after the opponent's penalty.", "We got a two-minute penalty for hooking.", "The forward ripped a strong wrist shot into the top corner."]}, "detail": {"prompt": "What exactly did you hear (in Polish)?", "correct": "Uda≈Ço nam siƒô utrzymaƒá prowadzenie dziƒôki dobrej obronie w os≈Çabieniu.", "distractor_bank": ["KrƒÖ≈ºek wpad≈Ç do bramki po dobitce napastnika.", "Dostali≈õmy dwie minuty kary za zahaczanie.", "Sƒôdzia odgwizda≈Ç spalonego na niebieskiej linii.", "Na lodowisku gra po sze≈õciu zawodnik√≥w z ka≈ºdej dru≈ºyny, w tym bramkarz.", "Bramkarz obroni≈Ç strza≈Ç parkanami.", "Obro≈Ñca zablokowa≈Ç uderzenie z klepy.", "Trener poprosi≈Ç o czas, ≈ºeby ustawiƒá ostatniƒÖ zmianƒô.", "Gramy w przewadze po karze przeciwnika.", "Napastnik odda≈Ç mocny strza≈Ç z nadgarstka w okienko."]}}, {"id": "d010", "audio": "listening/d010.mp3", "duration_s": 0, "transcript_pl": "Trener poprosi≈Ç o czas, ≈ºeby ustawiƒá ostatniƒÖ zmianƒô.", "translation_en": "The coach called a timeout to set up the last shift.", "gist": {"prompt": "Which best matches the audio?", "correct": "The coach called a timeout to set up the last shift.", "distractors": ["There are six players on the ice per team, including the goalie.", "We're on the power play after the opponent's penalty.", "We got a two-minute penalty for hooking."]}, "detail": {"prompt": "What exactly did you hear (in Polish)?", "correct": "Trener poprosi≈Ç o czas, ≈ºeby ustawiƒá ostatniƒÖ zmianƒô.", "distractor_bank": ["Sƒôdzia odgwizda≈Ç spalonego na niebieskiej linii.", "Uda≈Ço nam siƒô utrzymaƒá prowadzenie dziƒôki dobrej obronie w os≈Çabieniu.", "Dostali≈õmy dwie minuty kary za zahaczanie.", "KrƒÖ≈ºek wpad≈Ç do bramki po dobitce napastnika.", "Bramkarz obroni≈Ç strza≈Ç parkanami.", "Gramy w przewadze po karze przeciwnika.", "Na lodowisku gra po sze≈õciu zawodnik√≥w z ka≈ºdej dru≈ºyny, w tym bramkarz.", "Obro≈Ñca zablokowa≈Ç uderzenie z klepy.", "Napastnik odda≈Ç mocny strza≈Ç z nadgarstka w okienko."]}}];


  // ‚Äî‚Äî‚Äî‚Äî‚Äî State ‚Äî‚Äî‚Äî‚Äî‚Äî
  const state = {
    i: 0,
    gold: 0,
    usedSlow: false,
    replays: 0,
    wrongGist: 0,
    wrongDetail: 0,
    answeredGist: false,
    answeredDetail: false,
    gistTriesLeft: CONFIG.triesPerQuestion,
    detailTriesLeft: CONFIG.triesPerQuestion,
    currentDurationS: 0,
    perDialogueLog: [],
    started: false,
  };

  // ‚Äî‚Äî‚Äî‚Äî‚Äî DOM helpers ‚Äî‚Äî‚Äî‚Äî‚Äî
  const $ = (id) => document.getElementById(id);
  const playBtn = $("playBtn");
  const speedBtn = $("speedBtn");
  const replayBtn = $("replayBtn");
  const nextBtn = $("nextBtn");
  const homeBtn = $("homeBtn");
  const toHomeBtn = $("toHomeBtn");
  const restartBtn = $("restartBtn");
  const audioEl = $("audio");

  const gistCard = $("gistCard");
  const gistPrompt = $("gistPrompt");
  const gistChoices = $("gistChoices");

  const detailCard = $("detailCard");
  const detailPrompt = $("detailPrompt");
  const detailChoices = $("detailChoices");

  const revealCard = $("revealCard");
  const plText = $("plText");
  const enText = $("enText");

  const summaryCard = $("summaryCard");
  const summaryBody = $("summaryBody");

  const goldLbl = $("gold");
  const progressLbl = $("progress");
  const countLabel = $("countLabel");
  const lengthLabel = $("lengthLabel");
  const replayLabel = $("replayLabel");

  function repoBase() {
    // Matches patterns used in other modes hosted on GitHub Pages
    const p = window.location.pathname.split("/").filter(Boolean);
    if (window.location.hostname.includes("github.io")) {
      // /<repo>/listening/<set>/
      return "/" + p[0];
    }
    return "";
  }

  function gotoHome() {
    if (window.location.hostname.includes("github.io")) {
      window.location.href = repoBase() + "/";
    } else {
      window.location.href = "/";
    }
  }

  // ‚Äî‚Äî‚Äî‚Äî‚Äî Utils ‚Äî‚Äî‚Äî‚Äî‚Äî
  function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }
  function sampleDetailChoices(item) {
    const bank = (item.detail?.distractor_bank || []).slice();
    const correct = item.detail?.correct ?? "";
    const pruned = bank.filter(x => x !== correct);
    shuffle(pruned);
    const three = pruned.slice(0, 3);
    const combined = [correct, ...three];
    return shuffle(combined);
  }

  function computePool(item, usedSlow, replays, wrongGist, wrongDetail) {
    const base = CONFIG.basePerDialogue;
    const dur = (item.duration_s || state.currentDurationS || 0);
    const lenBonus = Math.min(CONFIG.lengthBonusCap, Math.floor(dur / CONFIG.lengthBonusEverySec));
    let pool = base + lenBonus;
    // Global penalties
    pool -= (usedSlow ? CONFIG.slowCost : 0);
    pool -= (replays * CONFIG.replayCost);
    if (pool < 0) pool = 0;
    // Shares
    const gShare = pool * CONFIG.weightGist;
    const dShare = pool * CONFIG.weightDetail;
    const gEarn = Math.max(0, Math.floor(gShare - wrongGist * CONFIG.wrongCost));
    const dEarn = Math.max(0, Math.floor(dShare - wrongDetail * CONFIG.wrongCost));
    return Math.max(0, gEarn + dEarn);
  }

  function setHidden(el, hidden=true) { el.classList.toggle("hidden", hidden); }
  function resetQuestionUI() {
    gistChoices.innerHTML = ""; detailChoices.innerHTML = "";
    [gistCard, detailCard, revealCard, summaryCard].forEach(el => setHidden(el, true));
    nextBtn.disabled = true;
  }

  function setHeader() {
    goldLbl.textContent = state.gold;
    progressLbl.textContent = `${state.i+1}/${DIALOGUES.length}`;
    countLabel.textContent = `Dialog ${state.i+1} of ${DIALOGUES.length}`;
    const dur = (DIALOGUES[state.i]?.duration_s || state.currentDurationS || 0);
    lengthLabel.textContent = dur ? `‚Ä¢ ${dur}s` : "";
    replayLabel.textContent = `‚Ä¢ Replays left: ${CONFIG.replayMax - state.replays}`;
  }

  function beginSessionIfNeeded() {
    if (!state.started) {
      state.gold += CONFIG.sessionBonus;
      state.started = true;
      goldLbl.textContent = state.gold;
    }
  }

  function audioUrlFor(item){
    // Prefer absolute URL if provided
    if (item.audio_url) return item.audio_url;

    const rel = (item.audio || "").replace(/^\/+/, "");
    if (!rel) return "";

    const encSet = encodeURIComponent(SET_NAME);
    if (window.location.hostname.includes("github.io")){
      // GitHub Pages: serve from /static/<set>/<rel>
      return repoBase() + `/static/${encSet}/${rel}`;
    }
    // Local dev: served by /custom_static ‚Üí docs/static
    return `/custom_static/${encSet}/${rel}`;
  }

  function loadAudio(item) {
    const src = audioUrlFor(item);
    if (!src) {
      console.warn("No audio for item", item);
      audioEl.removeAttribute("src");
      return;
    }
    audioEl.src = src;
    audioEl.playbackRate = state.usedSlow ? 0.75 : 1.0;
  }


  function renderGist(item) {
    if (!item.gist) return;
    setHidden(gistCard, false);
    gistPrompt.textContent = item.gist.prompt || "What is the gist?";
    const opts = shuffle([ item.gist.correct, ...(item.gist.distractors || []).slice(0,3) ]);
    gistChoices.innerHTML = "";
    opts.forEach((txt) => {
      const b = document.createElement("button");
      b.className = "choice"; b.textContent = txt;
      b.onclick = () => onGistAnswer(item, b, txt === item.gist.correct);
      gistChoices.appendChild(b);
    });
  }

  function renderDetail(item) {
    if (!item.detail) return;
    setHidden(detailCard, false);
    detailPrompt.textContent = item.detail.prompt || "What detail did you hear?";
    const opts = sampleDetailChoices(item);
    detailChoices.innerHTML = "";
    opts.forEach((txt) => {
      const b = document.createElement("button");
      b.className = "choice"; b.textContent = txt;
      b.onclick = () => onDetailAnswer(item, b, txt === item.detail.correct);
      detailChoices.appendChild(b);
    });
  }

  function renderReveal(item) {
    plText.textContent = item.transcript_pl || "(no transcript)";
    enText.textContent = item.translation_en || "";
    setHidden(revealCard, false);
  }

  function lockChoices(containerId) {
    const children = document.getElementById(containerId).children;
    for (const c of children) c.disabled = true;
  }

  function onGistAnswer(item, btn, correct) {
    if (state.answeredGist) return;
    if (correct) {
      btn.classList.add("correct");
      state.answeredGist = true;
      lockChoices("gistChoices");
      if (!state.answeredDetail) renderDetail(item);
      if (state.answeredDetail) finalizeDialogue(item);
      return;
    }
    // wrong
    btn.classList.add("wrong");
    btn.disabled = true;
    state.wrongGist++;
    state.gistTriesLeft--;
    if (state.gistTriesLeft <= 0) {
      state.answeredGist = true;
      // show correct
      [...gistChoices.children].forEach(c => {
        if (c.textContent === (item.gist?.correct || "")) c.classList.add("correct");
        c.disabled = true;
      });
      if (!state.answeredDetail) renderDetail(item);
      if (state.answeredDetail) finalizeDialogue(item);
    }
  }

  function onDetailAnswer(item, btn, correct) {
    if (state.answeredDetail) return;
    if (correct) {
      btn.classList.add("correct");
      state.answeredDetail = true;
      lockChoices("detailChoices");
      if (state.answeredGist) finalizeDialogue(item);
      return;
    }
    // wrong
    btn.classList.add("wrong");
    btn.disabled = true;
    state.wrongDetail++;
    state.detailTriesLeft--;
    if (state.detailTriesLeft <= 0) {
      state.answeredDetail = true;
      // show correct
      [...detailChoices.children].forEach(c => {
        if (c.textContent === (item.detail?.correct || "")) c.classList.add("correct");
        c.disabled = true;
      });
      if (state.answeredGist) finalizeDialogue(item);
    }
  }

  function finalizeDialogue(item) {
    // Compute payout
    const gained = computePool(item, state.usedSlow, state.replays, state.wrongGist, state.wrongDetail);
    state.gold += gained;
    state.perDialogueLog.push({
      id: item.id || `d${state.i+1}`,
      usedSlow: state.usedSlow,
      replays: state.replays,
      wrongGist: state.wrongGist,
      wrongDetail: state.wrongDetail,
      payout: gained,
      duration_s: item.duration_s || state.currentDurationS || 0,
    });
    goldLbl.textContent = state.gold;
    renderReveal(item);
    nextBtn.disabled = false;
  }

  function resetPerDialogue() {
    state.usedSlow = false;
    state.replays = 0;
    state.wrongGist = 0;
    state.wrongDetail = 0;
    state.answeredGist = false;
    state.answeredDetail = false;
    state.gistTriesLeft = CONFIG.triesPerQuestion;
    state.detailTriesLeft = CONFIG.triesPerQuestion;
    state.currentDurationS = 0;
    replayBtn.textContent = `Replay (${CONFIG.replayMax})`;
    replayBtn.disabled = false;
    speedBtn.disabled = false;
  }

  function startDialogue(idx) {
    if (idx >= DIALOGUES.length) return endSession();
    resetPerDialogue(); resetQuestionUI();
    const item = DIALOGUES[idx];
    // prefer authored duration until metadata loads
    state.currentDurationS = Math.round(item?.duration_s || 0);
    setHeader();
    loadAudio(item);
  }

  function endSession() {
    setHidden(gistCard,true); setHidden(detailCard,true); setHidden(revealCard,true);
    setHidden(summaryCard,false);
    const rows = state.perDialogueLog.map((r, k) => `#${k+1} ‚Ä¢ +${r.payout} gold ‚Ä¢ replay:${r.replays} ‚Ä¢ slow:${r.usedSlow?'y':'n'} ‚Ä¢ gist√ó${r.wrongGist} ‚Ä¢ detail√ó${r.wrongDetail}`).join("\n");
    summaryBody.textContent = `Total gold: ${state.gold}\n\n${rows}`;
  }

  // ‚Äî‚Äî‚Äî‚Äî‚Äî Wire up ‚Äî‚Äî‚Äî‚Äî‚Äî
  playBtn.onclick = () => {
    beginSessionIfNeeded();
    audioEl.play().catch(()=>{});
  };
  speedBtn.onclick = () => {
    if (state.usedSlow) return; // single-cost per dialogue
    state.usedSlow = true; audioEl.playbackRate = 0.75; speedBtn.disabled = true; // gold cost accounted at finalize
  };
  replayBtn.onclick = () => {
    if (state.replays >= CONFIG.replayMax) return;
    state.replays++; replayBtn.textContent = `Replay (${CONFIG.replayMax - state.replays})`;
    setHeader();
    audioEl.currentTime = 0; audioEl.play().catch(()=>{});
    if (state.replays >= CONFIG.replayMax) replayBtn.disabled = true;
  };
  nextBtn.onclick = () => { state.i++; if (state.i >= DIALOGUES.length) endSession(); else startDialogue(state.i); };
  homeBtn.onclick = gotoHome; toHomeBtn.onclick = gotoHome; restartBtn.onclick = () => window.location.reload();

  $("rEasy").onclick = () => console.log("rated: easy", DIALOGUES[state.i]?.id);
  $("rOk").onclick   = () => console.log("rated: ok", DIALOGUES[state.i]?.id);
  $("rHard").onclick = () => console.log("rated: hard", DIALOGUES[state.i]?.id);

  audioEl.addEventListener('ended', () => {
    // When audio finishes, show gist question
    const item = DIALOGUES[state.i];
    renderGist(item);
  });

  audioEl.addEventListener('loadedmetadata', () => {
    const d = isFinite(audioEl.duration) ? Math.round(audioEl.duration) : 0;
    if (d > 0) state.currentDurationS = d;
    setHeader();
  });

  // Initial mount
  (function init() {
    if (!Array.isArray(DIALOGUES) || DIALOGUES.length === 0) {
      document.body.innerHTML = '<div style="padding:20px;font-family:sans-serif;">‚ö†Ô∏è No dialogues found for this set.</div>';
      return;
    }
    setHidden(gistCard,true); setHidden(detailCard,true); setHidden(revealCard,true); setHidden(summaryCard,true);
    state.gold = 0;
    startDialogue(0);
  })();
  </script>
</body>
</html>
