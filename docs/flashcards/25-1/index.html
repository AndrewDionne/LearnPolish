<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>25-1 ‚Ä¢ Learn</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0; padding: 20px;
      background-color: #f8f9fa;
      display: flex; flex-direction: column; align-items: center;
      min-height: 100vh; box-sizing: border-box; overflow-x: hidden;
    }
    h1 {
      font-size: 1.5em; margin: 0 0 16px; position: relative; width: 100%; text-align: center;
    }
    .home-btn { position: absolute; right: 0; top: 0; font-size: 1.4em; background: none; border: none; cursor: pointer; }

    .card { width: 90%; max-width: 360px; height: 260px; perspective: 1000px; margin: 18px auto; }
    .card-inner {
      width: 100%; height: 100%; position: relative; transition: transform 0.6s; transform-style: preserve-3d;
      cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; justify-content: center; align-items: center; border-radius: 12px;
    }
    .card.flipped .card-inner { transform: rotateY(180deg); }
    .side {
      position: absolute; width: 100%; height: 100%; border-radius: 12px; padding: 20px; backface-visibility: hidden;
      display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
    }
    .front { background: #fff; }
    .back  { background: #e9ecef; transform: rotateY(180deg); }

    .cue { font-size: 1.1em; margin-bottom: 12px; }
    .answer-phrase { font-weight: 700; font-size: 1.2em; }
    .answer-pron   { font-style: italic; margin-top: 4px; }

    .actions { display: flex; gap: 8px; margin-top: 16px; }
    .btn-small {
      padding: 8px 12px; font-size: 1em; background-color: #2d6cdf; color: #fff;
      border: none; border-radius: 8px; cursor: pointer;
    }
    .btn-green { background-color: #28a745; }
    .result { margin-top: 8px; font-size: .95em; min-height: 1.2em; }

    .nav-buttons { display: flex; gap: 12px; margin-top: 16px; }
    .nav-button { padding: 8px 12px; font-size: 1em; background-color: #007bff; color: #fff; border: none; border-radius: 8px; min-width: 110px; cursor: pointer; }
    .nav-button:disabled { background-color: #aaa; cursor: default; }
  </style>
</head>
<body>
  <h1>25-1 ‚Ä¢ Learn <button class="home-btn" onclick="goHome()">üè†</button></h1>

  <div class="card" id="cardContainer" aria-live="polite">
    <div class="card-inner" id="cardInner">
      <div class="side front" id="frontSide">
        <div class="cue" id="frontCue"></div>
        <div class="actions">
          <button class="btn-small" id="btnSayFront">Say the answer</button>
        </div>
        <div class="result" id="frontResult"></div>
      </div>
      <div class="side back" id="backSide">
        <div class="answer-phrase" id="answerPhrase"></div>
        <div class="answer-pron" id="answerPron"></div>
        <div class="actions">
          <button class="btn-small btn-green" id="btnPlay">Play</button>
          <button class="btn-small" id="btnSayBack">Say the answer</button>
        </div>
        <div class="result" id="backResult"></div>
      </div>
    </div>
  </div>

  <div class="nav-buttons">
    <button id="prevBtn" class="nav-button">Previous</button>
    <button id="nextBtn" class="nav-button">Next</button>
  </div>

  <!-- Azure Speech SDK -->
  <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>

  <!-- Correct relative paths from /flashcards/<set>/index.html -->
  <script src="../../static/js/api.js"></script>
  <script src="../../static/js/session_state.js"></script>

  <script>
    // --- Data & state ---
    const cards = [{"phrase": "Cze≈õƒá", "pronunciation": "cheshch", "meaning": "Hello", "audio_file": "0_Czesc.mp3"}, {"phrase": "Dziƒôkujƒô", "pronunciation": "jen-koo-yeh", "meaning": "Thank you", "audio_file": "1_Dziekuje.mp3"}];
    const setName = "25-1";
    const mode = "learn"; // flashcards = learn
    let currentIndex = 0;

    // Mirror of Python sanitize_filename (for audio file names)
    function sanitizeFilename(text) {
      return (text || "")
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-zA-Z0-9_-]+/g, "_")
        .replace(/^_+|_+$/g, "");
    }

    // Relative audio path from nested page: ../../static/<set>/audio/<file>
    function getAudioPath(filename) {
      return "../../static/" + encodeURIComponent(setName) + "/audio/" + encodeURIComponent(filename);
    }

    function playAudioFor(index) {
      const e = cards[index] || {};
      const fn = String(index) + "_" + sanitizeFilename(e.phrase || "") + ".mp3";
      const audio = new Audio(getAudioPath(fn));
      audio.play().catch(()=>{});
    }

    function setDisabledStates() {
      document.getElementById("prevBtn").disabled = (currentIndex === 0);
      document.getElementById("nextBtn").disabled = (currentIndex >= cards.length - 1);
    }

    function renderCard() {
      const entry = cards[currentIndex] || {};
      // Front: cue (meaning) + Say it (no answer shown)
      document.getElementById("frontCue").textContent = entry.meaning || "";
      document.getElementById("frontResult").textContent = "";

      // Back: full answer
      document.getElementById("answerPhrase").textContent = entry.phrase || "";
      document.getElementById("answerPron").textContent   = entry.pronunciation || "";
      document.getElementById("backResult").textContent   = "";

      // Buttons wired below each time
      setDisabledStates();
    }

    // Assess helper writes into a provided target element (front/back)
    async function assessPronunciation(referenceText, targetEl) {
      if (!referenceText) {
        targetEl.textContent = "‚Äî";
        return;
      }
      targetEl.textContent = "‚è≥ Listening‚Ä¶";
      if (!window.SpeechSDK) {
        targetEl.textContent = "‚ùå Azure SDK not loaded.";
        return;
      }
      try {
        const r = await api.fetch("/api/token");
        if (!r.ok) throw new Error("token");
        const data = await r.json();

        const speechConfig = SpeechSDK.SpeechConfig.fromAuthorizationToken(data.token, data.region);
        speechConfig.speechRecognitionLanguage = "pl-PL";
        speechConfig.setProperty(SpeechSDK.PropertyId.SpeechServiceConnection_InitialSilenceTimeoutMs, "6000");
        speechConfig.setProperty(SpeechSDK.PropertyId.SpeechServiceConnection_EndSilenceTimeoutMs, "1200");

        const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
        const recognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);

        const pa = new SpeechSDK.PronunciationAssessmentConfig(
          referenceText,
          SpeechSDK.PronunciationAssessmentGradingSystem.HundredMark,
          SpeechSDK.PronunciationAssessmentGranularity.Word,
          true
        );
        pa.applyTo(recognizer);

        recognizer.recognizeOnceAsync(result => {
          try {
            const resJson = result && result.json ? JSON.parse(result.json) : null;
            const words = resJson && resJson.NBest && resJson.NBest[0].Words ? resJson.NBest[0].Words : [];
            const avg = words.length ? (
              words.reduce((a,b) => a + (b.PronunciationAssessment?.AccuracyScore || 0), 0) / words.length
            ).toFixed(1) : "0";

            const ok = Number(avg) >= 75; // success threshold
            const wordHtml = words.map(w => {
              const score = w.PronunciationAssessment?.AccuracyScore || 0;
              const color = score >= 85 ? "green" : score >= 70 ? "orange" : "red";
              return `<span style="color:${color}; margin:0 4px;">${w.Word}</span>`;
            }).join(" ");

            targetEl.innerHTML = `<div><strong>${ok ? "Nice!" : "Not quite"}:</strong> ${avg}%</div>` +
                                 (wordHtml ? `<div style="margin-top:5px;">${wordHtml}</div>` : "");
            if (!ok) {
              // invite to flip for answer
              targetEl.innerHTML += `<div style="margin-top:6px;">Flip the card to check the answer.</div>`;
            }
          } catch (err) {
            console.warn("Parse error:", err);
            targetEl.textContent = "‚ö†Ô∏è Error parsing result.";
          }
          recognizer.close();
        }, err => {
          console.error("Azure error:", err);
          targetEl.textContent = "‚ùå Recognition failed.";
          recognizer.close();
        });
      } catch (err) {
        console.error("Azure token error:", err);
        targetEl.textContent = "‚ùå Azure token error.";
      }
    }

    // Wiring
    document.addEventListener("DOMContentLoaded", () => {
      renderCard();

      // Flip on tap anywhere on the card (but not when pressing buttons/results)
      document.getElementById("cardContainer").addEventListener("click", (e) => {
        if (e.target.closest("button") || e.target.classList.contains("result")) return;
        document.getElementById("cardContainer").classList.toggle("flipped");
      });

      // Front: Say it (uses hidden reference phrase)
      document.getElementById("btnSayFront").addEventListener("click", (e) => {
        e.stopPropagation();
        const entry = cards[currentIndex] || {};
        assessPronunciation(entry.phrase || "", document.getElementById("frontResult"));
      });

      // Back: Play + Say again
      document.getElementById("btnPlay").addEventListener("click", (e) => {
        e.stopPropagation();
        playAudioFor(currentIndex);
      });
      document.getElementById("btnSayBack").addEventListener("click", (e) => {
        e.stopPropagation();
        const entry = cards[currentIndex] || {};
        assessPronunciation(entry.phrase || "", document.getElementById("backResult"));
      });

      // Navigation
      document.getElementById("prevBtn").addEventListener("click", () => {
        if (currentIndex > 0) {
          currentIndex--;
          renderCard();
          if (window.SessionSync) SessionSync.save({ setName, mode, progress: { index: currentIndex } });
        }
      });
      document.getElementById("nextBtn").addEventListener("click", () => {
        if (currentIndex < cards.length - 1) {
          currentIndex++;
          renderCard();
          if (window.SessionSync) SessionSync.save({ setName, mode, progress: { index: currentIndex } });
        }
        // else if (window.SessionSync) SessionSync.complete({ setName, mode });
      });
    });

    // Resume mid-set if ?resume=1
    (async () => {
      const wantResume = new URL(location.href).searchParams.get("resume") === "1";
      if (wantResume && window.SessionSync) {
        await SessionSync.restore({ setName, mode }, (progress) => {
          if (Number.isFinite(progress.index)) {
            currentIndex = Math.max(0, Math.min(cards.length - 1, progress.index));
            renderCard();
          }
        });
      }
      try { localStorage.setItem("lp_last", JSON.stringify({ set_name:setName, mode, ts: Date.now() })); } catch (_) {}
    })();

    // Home button ‚Üí docs/index.html
    function goHome() { window.location.href = "../../index.html"; }
  </script>
</body>
</html>
