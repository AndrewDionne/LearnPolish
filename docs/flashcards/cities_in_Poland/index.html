<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>cities_in_Poland ‚Ä¢ Learn</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont, sans-serif; margin:0; padding:20px; background:#f8f9fa; display:flex; flex-direction:column; align-items:center; min-height:100vh; }
    h1 { font-size:1.5em; margin:0 0 16px; position:relative; width:100%; text-align:center; }
    .home-btn { position:absolute; right:0; top:0; font-size:1.4em; background:none; border:none; cursor:pointer; }

    .card { width:90%; max-width:360px; height:260px; perspective:1000px; margin:18px auto; }
    .card-inner {
      width:100%; height:100%; position:relative; transition:transform .6s; transform-style:preserve-3d;
      cursor:pointer; box-shadow:0 4px 10px rgba(0,0,0,.1); display:flex; justify-content:center; align-items:center; border-radius:12px;
    }
    .card.flipped .card-inner { transform: rotateY(180deg); }
    .side { position:absolute; width:100%; height:100%; border-radius:12px; padding:20px; backface-visibility:hidden; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; }
    .front { background:#fff; }
    .back  { background:#e9ecef; transform:rotateY(180deg); }

    .cue { font-size:1.1em; margin-bottom:12px; }
    .answer-phrase { font-weight:700; font-size:1.2em; }
    .answer-pron { font-style:italic; margin-top:4px; }

    .actions { display:flex; gap:8px; margin-top:16px; }
    .btn-small { padding:8px 12px; font-size:1em; background:#2d6cdf; color:#fff; border:none; border-radius:8px; cursor:pointer; }
    .btn-green { background:#28a745; }

    .result { margin-top:8px; font-size:.95em; min-height:1.2em; }

    .nav-buttons { display:flex; gap:12px; margin-top:16px; }
    .nav-button { padding:8px 12px; font-size:1em; background:#007bff; color:#fff; border:none; border-radius:8px; min-width:110px; cursor:pointer; }
    .nav-button:disabled { background:#aaa; cursor:default; }
  </style>
</head>
<body>
  <h1>cities_in_Poland ‚Ä¢ Learn <button class="home-btn" onclick="goHome()">üè†</button></h1>

  <div class="card" id="cardContainer" aria-live="polite">
    <div class="card-inner" id="cardInner">
      <div class="side front" id="frontSide">
        <div class="cue" id="frontCue"></div>
        <div class="actions">
          <button class="btn-small" id="btnSayFront">Say it in Polish</button>
        </div>
        <div class="result" id="frontResult"></div>
      </div>
      <div class="side back" id="backSide">
        <div class="answer-phrase" id="answerPhrase"></div>
        <div class="answer-pron" id="answerPron"></div>
        <div class="actions">
          <button class="btn-small btn-green" id="btnPlay">Play</button>
        </div>
        <div class="result" id="backResult"></div>
      </div>
    </div>
  </div>

  <div class="nav-buttons">
    <button id="prevBtn" class="nav-button">Previous</button>
    <button id="nextBtn" class="nav-button">Next</button>
  </div>

  <!-- Azure Speech SDK -->
  <!-- Azure Speech SDK removed: using static MP3 playback only -->

  <!-- Correct relative paths from /flashcards/<class 'set'>/index.html -->
  <script src="../../static/js/app-config.js"></script>
  <script src="../../static/js/api.js"></script>
  <script src="../../static/js/session_state.js"></script>
  <script src="../../static/js/audio-paths.js"></script>

    <script>
    // --- Data & state ---
    const cards = [{"phrase": "Warszawa", "meaning": "Warsaw", "pronunciation": "var-SHAH-vah", "audio_file": "0_Warszawa.mp3"}, {"phrase": "Krak√≥w", "meaning": "Krakow", "pronunciation": "KRAH-koof", "audio_file": "1_Krakow.mp3"}, {"phrase": "≈Å√≥d≈∫", "meaning": "Lodz", "pronunciation": "WOODJ", "audio_file": "2_odz.mp3"}, {"phrase": "Wroc≈Çaw", "meaning": "Wroclaw", "pronunciation": "VROTS-wav", "audio_file": "3_Wroc_aw.mp3"}, {"phrase": "Pozna≈Ñ", "meaning": "Poznan", "pronunciation": "POHZ-nan", "audio_file": "4_Poznan.mp3"}, {"phrase": "Gda≈Ñsk", "meaning": "Gdansk", "pronunciation": "GDAN-sk", "audio_file": "5_Gdansk.mp3"}, {"phrase": "Szczecin", "meaning": "Szczecin", "pronunciation": "SHTCHEH-cheen", "audio_file": "6_Szczecin.mp3"}, {"phrase": "Bydgoszcz", "meaning": "Bydgoszcz", "pronunciation": "BID-goshch", "audio_file": "7_Bydgoszcz.mp3"}, {"phrase": "Lublin", "meaning": "Lublin", "pronunciation": "LOO-blin", "audio_file": "8_Lublin.mp3"}, {"phrase": "Bia≈Çystok", "meaning": "Bialystok", "pronunciation": "BYAH-wi-stok", "audio_file": "9_Bia_ystok.mp3"}, {"phrase": "Katowice", "meaning": "Katowice", "pronunciation": "kah-toh-VEE-tseh", "audio_file": "10_Katowice.mp3"}, {"phrase": "Gdynia", "meaning": "Gdynia", "pronunciation": "GDI-nyah", "audio_file": "11_Gdynia.mp3"}, {"phrase": "Czƒôstochowa", "meaning": "Czestochowa", "pronunciation": "CHEN-sto-ho-vah", "audio_file": "12_Czestochowa.mp3"}, {"phrase": "Radom", "meaning": "Radom", "pronunciation": "RAH-dom", "audio_file": "13_Radom.mp3"}, {"phrase": "Sosnowiec", "meaning": "Sosnowiec", "pronunciation": "SOSH-no-vyets", "audio_file": "14_Sosnowiec.mp3"}, {"phrase": "Toru≈Ñ", "meaning": "Torun", "pronunciation": "TOH-roon", "audio_file": "15_Torun.mp3"}, {"phrase": "Rzesz√≥w", "meaning": "Rzeszow", "pronunciation": "ZHEH-shoof", "audio_file": "16_Rzeszow.mp3"}, {"phrase": "Kielce", "meaning": "Kielce", "pronunciation": "KYEL-tseh", "audio_file": "17_Kielce.mp3"}, {"phrase": "Olsztyn", "meaning": "Olsztyn", "pronunciation": "OL-shtin", "audio_file": "18_Olsztyn.mp3"}, {"phrase": "Opole", "meaning": "Opole", "pronunciation": "OH-poh-leh", "audio_file": "19_Opole.mp3"}, {"phrase": "ElblƒÖg", "meaning": "Elblag", "pronunciation": "EL-blong", "audio_file": "20_Elblag.mp3"}, {"phrase": "P≈Çock", "meaning": "Plock", "pronunciation": "PWOTS-k", "audio_file": "21_P_ock.mp3"}, {"phrase": "Zielona G√≥ra", "meaning": "Zielona Gora", "pronunciation": "zyeh-LOH-nah GOO-rah", "audio_file": "22_Zielona_Gora.mp3"}, {"phrase": "Tychy", "meaning": "Tychy", "pronunciation": "TIH-khy", "audio_file": "23_Tychy.mp3"}, {"phrase": "Koszalin", "meaning": "Koszalin", "pronunciation": "KOH-shah-leen", "audio_file": "24_Koszalin.mp3"}, {"phrase": "Kalisz", "meaning": "Kalisz", "pronunciation": "KAH-lish", "audio_file": "25_Kalisz.mp3"}, {"phrase": "Legnica", "meaning": "Legnica", "pronunciation": "LEG-nee-tsah", "audio_file": "26_Legnica.mp3"}, {"phrase": "GrudziƒÖdz", "meaning": "Grudziadz", "pronunciation": "GROO-jondz", "audio_file": "27_Grudziadz.mp3"}, {"phrase": "Jaworzno", "meaning": "Jaworzno", "pronunciation": "YAH-vozh-no", "audio_file": "28_Jaworzno.mp3"}];
    const setName = "cities_in_Poland";
    const mode = "flashcards";
    let currentIndex = 0;

    // Optional CDN manifest (loaded later; safe to be null)
    let r2Manifest = null;

    // Scoring + points
    const PASS = 75;
    const tracker = {
      attempts: 0,
      per: {},               // per[idx] = { tries, best, got100BeforeFlip: boolean }
      perfectNoFlipCount: 0,   // increments when avg==100 before first flip on that card
    };
    let hasFlippedCurrent = false;

    // Mirror of Python sanitize_filename (for audio file names)
    function sanitizeFilename(text) {
      return (text || "")
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-zA-Z0-9_-]+/g, "_")
        .replace(/^_+|_+$/g, "");
    }

    // Local static fallback (used if no manifest/CDN mapping)
    function localAudioPath(index) {
      const e = cards[index] || {};
      const fn = String(index) + "_" + sanitizeFilename(e.phrase || "") + ".mp3";
      const setEnc = encodeURIComponent(setName);
      const fnEnc  = encodeURIComponent(fn);

      // Absolute URL in data wins
      const explicit = e.audio_url || e.audio;
      if (explicit && /^https?:\/\//i.test(explicit)) return explicit;

      return `../../static/${setEnc}/audio/${fnEnc}`;
    }

    function setNavUI() {
      document.getElementById("prevBtn").disabled = (currentIndex === 0);
      const nextBtn = document.getElementById("nextBtn");
      nextBtn.textContent = (currentIndex < cards.length - 1) ? "Next" : "Finish";
    }

    function renderCard() {
      const e = cards[currentIndex] || {};
      // Front
      document.getElementById("frontCue").textContent = e.meaning || "";
      document.getElementById("frontResult").textContent = "";
      // Back
      document.getElementById("answerPhrase").textContent = e.phrase || "";
      document.getElementById("answerPron").textContent   = e.pronunciation || "";
      document.getElementById("backResult").textContent   = "";
      setNavUI();
      hasFlippedCurrent = false;  // reset flip flag each card
    }

    async function assess(referenceText, targetEl) {
      if (targetEl) targetEl.textContent = "üîá Pronunciation scoring is temporarily disabled.";
      return { score: 0 };
    }

    // Wire up after DOM is ready (prevents null refs)
    window.addEventListener("DOMContentLoaded", async function() {
      // Try to load R2 manifest (non-blocking; safe if missing)
      try {
        if (window.AudioPaths) {
          r2Manifest = await AudioPaths.fetchManifest(setName);
        }
      } catch (_e) {
        r2Manifest = null;
      }

      renderCard();

      // Flip on tap (ignore buttons/result)
      document.getElementById("cardContainer").addEventListener("click", (e) => {
        if (e.target.closest("button") || e.target.classList.contains("result")) return;
        document.getElementById("cardContainer").classList.toggle("flipped");
        hasFlippedCurrent = true;
      });

      // Front: Say it
      document.getElementById("btnSayFront").addEventListener("click", (e) => {
        e.stopPropagation();
        const eCard = cards[currentIndex] || {};
        assess(eCard.phrase || "", document.getElementById("frontResult"));
      });

      // Back: Play
      document.getElementById("btnPlay").addEventListener("click", async (e) => {
        e.stopPropagation();
        // Prefer manifest/CDN mapping if available; else local static path
        let src = localAudioPath(currentIndex);
        try {
          if (window.AudioPaths) {
            src = AudioPaths.buildAudioPath(setName, currentIndex, cards[currentIndex], r2Manifest);
          }
        } catch (_ignore) {}
        const audio = new Audio(src);
        audio.play().catch(()=>{});
      });

      // Prev / Next / Finish
      document.getElementById("prevBtn").addEventListener("click", () => {
        if (currentIndex > 0) {
          currentIndex--;
          renderCard();
          if (window.SessionSync) SessionSync.save({ setName, mode, progress: { index: currentIndex, per: tracker.per } });
        }
      });

      document.getElementById("nextBtn").addEventListener("click", async () => {
        if (currentIndex < cards.length - 1) {
          currentIndex++;
          renderCard();
          if (window.SessionSync) SessionSync.save({ setName, mode, progress: { index: currentIndex, per: tracker.per } });
        } else {
          // FINISH
          const totalCards = Math.max(1, cards.length);
          const correct = Object.values(tracker.per).filter(r => (r?.best || 0) >= PASS).length;
          const scorePct = Math.round((correct / totalCards) * 100);

          // Points:
          //  - base 10 for finishing
          //  - +1 per 100%-before-first-flip
          //  - if score==100, 2x the total
          let pointsTotal = 10 + tracker.perfectNoFlipCount;
          if (scorePct === 100) pointsTotal = pointsTotal * 2;

          // Cache locally for summary
          try {
            localStorage.setItem("lp_last_result_" + setName, JSON.stringify({
              score: scorePct,
              attempts: tracker.attempts,
              total: totalCards,
              points_total: pointsTotal,
              perfect_before_flip: tracker.perfectNoFlipCount
            }));
          } catch (_ignore) {}

          // Submit to server
          let awarded = null;
          try {
            const resp = await api.fetch("/api/submit_score", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                set_name: setName,
                mode: "flashcards",
                score: scorePct,
                attempts: tracker.attempts,
                details: {
                  per: tracker.per,
                  total: totalCards,
                  perfect_before_flip: tracker.perfectNoFlipCount,
                  points_total: pointsTotal
                }
              })
            });
            if (resp.ok) {
              const js = await resp.json();
              awarded = (js && js.details && js.details.points_awarded != null)
                ? Number(js.details.points_awarded) : null;
            }
          } catch (_ignore) {}

          // Clear session state & go to summary
          try { if (window.SessionSync) await SessionSync.complete({ setName, mode }); } catch(_ignore) {}
          try { localStorage.removeItem("lp_last"); } catch(_ignore) {}
          const q = awarded != null ? ("?awarded=" + encodeURIComponent(awarded)) : "";
          window.location.href = "summary.html" + q;
        }
      });

      // Resume mid-set if ?resume=1
      (async () => {
        const wantResume = new URL(location.href).searchParams.get("resume") === "1";
        if (wantResume && window.SessionSync) {
          await SessionSync.restore({ setName, mode }, (progress) => {
            if (progress && Number.isFinite(progress.index)) {
              currentIndex = Math.max(0, Math.min(cards.length - 1, progress.index));
            }
            if (progress && progress.per) Object.assign(tracker.per, progress.per);
            renderCard();
          });
        }
        // Always record "last activity" (Home "Continue" fallback)
        try { localStorage.setItem("lp_last", JSON.stringify({ set_name:setName, mode, ts: Date.now() })); } catch(_ignore) {}
      })();
    });

    function goHome() { window.location.href = "../../index.html"; }
  </script>

</body>
</html>
