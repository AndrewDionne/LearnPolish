<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Path to POLISH â€¢ Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Dual-host <base> (GitHub Pages vs Flask/Render) -->
  <script>
    (function () {
      var isGH = /\.github\.io$/i.test(location.hostname);
      var baseHref = isGH ? '/LearnPolish/' : '/';
      document.write('<base href="' + baseHref + '">');
    })();
  </script>

  <link rel="stylesheet" href="static/app.css">
  <style>
    :root{
      --brand:#2d6cdf;
      --bg:#f7f7fb; --card:#ffffff; --text:#0c0f14; --muted:#5a6472; --border:#e6e6ef;
      --shadow:0 8px 24px rgba(0,0,0,.08);
      --radius:14px; --pad:16px; --gap:16px; --tap:48px;
      --gold:#c99200; --gold-soft:#ffe8a3;
      --focus:0 0 0 3px rgba(45,108,223,.35);
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0b0c10; --card:#121418; --text:#e7e9ee; --muted:#a7b0bf; --border:#1e2230; --shadow:0 6px 22px rgba(0,0,0,.35); --gold:#ffd35a; --gold-soft:#5a4700; }
    }
    *{ box-sizing:border-box }
    body{ font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Ubuntu,Helvetica,Arial; background:var(--bg); color:var(--text); margin:0; }

    main{ max-width:1100px; margin:16px auto 90px; padding:0 16px; display:grid; gap:16px; grid-template-columns:1fr 1fr; }
    @media (max-width:960px){ main{ grid-template-columns:1fr; } }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:var(--pad); box-shadow:var(--shadow) }
    h2{ margin:0 0 8px; font-size:clamp(20px,4.8vw,28px) }
    h3{ margin:0 0 8px; font-size:clamp(16px,2.6vw,18px) }
    .muted{ color:var(--muted) }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .col{ display:flex; flex-direction:column; gap:8px }
    label{ font-size:13px; color:var(--muted) }
    input[type="text"], input[type="email"], input[type="number"], input[type="file"]{
      width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:var(--card); color:var(--text);
    }
    .btn{ display:inline-flex; align-items:center; justify-content:center; height:var(--tap); padding:0 14px; border-radius:10px; border:1px solid var(--border); background:var(--card); color:var(--text); font-weight:600; text-decoration:none; cursor:pointer }
    .btn-primary{ background:var(--brand); color:#fff; border-color:transparent }
    .btn-danger{ border-color:#e7b0b0; color:#8d1e1e; background:rgba(255,0,0,.06) }
    .btn:focus{ outline:none; box-shadow:var(--focus) }

    .avatar-big{
      width:88px; height:88px; border-radius:18px; border:1px solid var(--border);
      background:linear-gradient(135deg,#e6edff,#fff5db); display:flex; align-items:center; justify-content:center; font-size:46px;
    }

    .avatars{ display:grid; grid-template-columns:repeat(6,1fr); gap:10px }
    @media (max-width:520px){ .avatars{ grid-template-columns:repeat(4,1fr); } }
    .ava{
      border:1px solid var(--border); border-radius:12px; background:var(--card); height:56px; display:flex; align-items:center; justify-content:center;
      cursor:pointer; font-size:28px; transition:transform .05s ease;
    }
    .ava:hover{ transform: translateY(-1px); }
    .ava.active{ outline:2px solid rgba(45,108,223,.35) }

    .bar{ height:10px; background:#e9ecf6; border-radius:999px; overflow:hidden; border:1px solid var(--border) }
    .bar > i{ display:block; height:100%; width:0%; background:var(--brand); }

    .coinstack{ width:24px; height:20px; display:inline-block; vertical-align:middle }
    .coinstack svg{ width:100%; height:100% }

    .tiny{ font-size:12px; color:var(--muted) }

    .chip{
      border-radius:999px;
      border:1px solid var(--border);
      padding:6px 10px;
      background:var(--card);
      display:inline-flex;
      flex-direction:column;
      align-items:flex-start;
      gap:2px;
      cursor:pointer;
      font-size:13px;
      transition:background .12s ease, color .12s ease, border-color .12s ease;
    }
    .chip .tiny{
      font-size:11px;
    }
    .chip.active{
      background:var(--brand);
      color:#fff;
      border-color:transparent;
    }
    .chip.active .tiny{
      color:rgba(255,255,255,.9);
    }

    /* Avatar modal */
    .modal-overlay{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(15,23,42,.72);
      z-index:1000;
    }
    .modal-overlay.show{
      display:flex;
    }
    body.modal-open{
      overflow:hidden;
    }
    .modal-dialog{
      background:var(--card);
      border-radius:var(--radius);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      padding:16px;
      max-width:420px;
      width:calc(100% - 32px);
    }
    .modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .modal-body{
      max-height:60vh;
      overflow:auto;
      padding-top:4px;
    }
    .modal-footer{
      margin-top:10px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }
    .icon-btn{
      border:none;
      background:transparent;
      cursor:pointer;
      font-size:20px;
      line-height:1;
      padding:4px;
      border-radius:999px;
      color:var(--muted);
    }
    .icon-btn:focus{
      outline:none;
      box-shadow:var(--focus);
    }

    nav.bottom{ position:fixed; left:0; right:0; bottom:0; background:var(--card); border-top:1px solid var(--border); display:flex; justify-content:space-around; padding:6px 8px; gap:8px; }
    nav.bottom a{ flex:1; text-align:center; padding:8px; text-decoration:none; color:var(--text); border-radius:10px; display:flex; flex-direction:column; align-items:center; gap:4px; font-size:12px }
    nav.bottom a svg{ width:20px; height:20px }
    nav.bottom a.active{ background:rgba(45,108,223,.12); color:var(--brand) }
    @supports(padding: max(0px)){ nav.bottom{ padding-bottom: max(6px, env(safe-area-inset-bottom)) } }
  </style>
</head>
<body>

  <main>
    <!-- Left column -->
    <section class="card">
      <h2>Profile</h2>
      <div class="row" style="margin-top:6px">
        <div id="avatarBig" class="avatar-big" aria-label="Your avatar">ðŸ™‚</div>
        <div class="col" style="flex:1; min-width:220px">
          <div>
            <label for="displayName">Display name</label>
            <input id="displayName" type="text" placeholder="Your name" />
          </div>
          <div>
            <label for="email">Email</label>
            <input id="email" type="email" disabled />
          </div>
        </div>
      </div>

      <!-- Avatar button -->
      <div class="row" style="margin-top:8px">
        <button id="chooseAvatarBtn" class="btn">Choose avatar</button>
      </div>

      <div class="row" style="margin-top:8px">
        <a class="btn" href="reset.html">Reset password</a>
        <button id="logoutBtn" class="btn">Log out</button>
      </div>
      <div class="tiny" style="margin-top:6px" id="joinDate">Joined â€”</div>
    </section>

    <!-- Goals -->
    <section class="card">
      <h3>Goals</h3>
      <p class="tiny" style="margin-bottom:8px">
        Choose how you want gold goals to behave.
      </p>

      <div class="row" style="gap:8px; margin-bottom:10px; flex-wrap:wrap">
        <button type="button" class="btn goal-mode-btn" data-mode="self" style="flex:1; min-width:160px">
          Learn at your own pace
        </button>
        <button type="button" class="btn goal-mode-btn" data-mode="path" style="flex:1; min-width:160px">
          Follow the Path to POLISH
        </button>
      </div>

      <div class="row" style="align-items:flex-end">
        <div style="flex:1; min-width:220px">
          <label for="weeklyGoal">Weekly gold goal</label>
          <input id="weeklyGoal" type="number" min="50" step="10" value="500" />
          <div class="row" style="margin-top:6px">
            <span class="coinstack" aria-hidden="true">
              <svg viewBox="0 0 64 48">
                <ellipse cx="18" cy="18" rx="14" ry="8" fill="var(--gold-soft)" stroke="var(--gold)" stroke-width="2"/>
                <ellipse cx="34" cy="24" rx="14" ry="8" fill="var(--gold-soft)" stroke="var(--gold)" stroke-width="2"/>
                <ellipse cx="46" cy="16" rx="14" ry="8" fill="var(--gold-soft)" stroke="var(--gold)" stroke-width="2"/>
              </svg>
            </span>
            <span id="goalHint" class="tiny">
              Used for your weekly progress bar & treasure chest.
            </span>
          </div>
        </div>
      </div>

      <!-- Unified Save & exit / Cancel -->
      <div class="row" style="margin-top:10px; justify-content:flex-end; gap:8px">
        <span id="saveMsg" class="tiny" style="margin-right:auto;"></span>
        <button id="cancelBtn" class="btn">Cancel</button>
        <button id="saveBtn" class="btn btn-primary">Save &amp; exit</button>
      </div>
    </section>

    <!-- Preferences: language + TTS voice -->
    <section class="card">
      <h3>Preferences</h3>
      <div class="col" style="gap:10px">

        <!-- Keep UI language wired but hidden -->
        <div id="uiLangRow" style="display:none">
          <label for="uiLang">Interface language</label>
          <select id="uiLang" style="width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:var(--card); color:var(--text);">
            <option value="en">English</option>
            <option value="pl">Polski (beta)</option>
          </select>
        </div>

        <div>
          <label for="ttsChoice">Polish voice</label>
          <select id="ttsChoice" style="width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:var(--card); color:var(--text);">
            <option value="azure:pl-PL-ZofiaNeural">Zofia â€” natural & warm (Azure)</option>
            <option value="azure:pl-PL-MarekNeural">Marek â€” neutral (Azure)</option>
            <option value="gtts:pl">Andrzej â€” simple & offline (gTTS)</option>
          </select>
          <div class="tiny" style="margin-top:6px">
            Zofia and Marek use Azure neural TTS when available. Andrzej uses the simpler gTTS fallback.
          </div>
        </div>

      </div>
    </section>

    <!-- Learning preferences -->
    <section class="card">
      <h3>Learning preferences</h3>
      <p class="tiny" style="margin-bottom:8px">
        These settings live on this device and change how strict pronunciation scoring is
        in Flashcards and Practice.
      </p>

      <div class="row" style="gap:10px; align-items:flex-end">
        <div style="flex:1; min-width:220px">
          <label>Pronunciation difficulty</label>
          <div id="pronDiffChips"
               style="display:flex; gap:8px; flex-wrap:wrap; margin-top:6px">
            <button type="button" class="chip diff-pref" data-diff="easy">
              Easy
              <span class="tiny">More lenient</span>
            </button>
            <button type="button" class="chip diff-pref" data-diff="normal">
              Normal
              <span class="tiny">Balanced</span>
            </button>
            <button type="button" class="chip diff-pref" data-diff="hard">
              Hard
              <span class="tiny">More strict</span>
            </button>
          </div>
          <div class="tiny" style="margin-top:6px">
            Applies to pronunciation checks in Flashcards &amp; Practice.
          </div>
        </div>
      </div>
    </section>

    <!-- Danger zone -->
    <section class="card">
      <h3>Delete account</h3>
      <p class="tiny">
        Deleting your account will remove your scores, groups, and collections. This cannot be undone.
      </p>
      <button id="deleteBtn" class="btn btn-danger">Delete my account</button>
    </section>

    <!-- Avatar picker modal -->
    <div id="avatarModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="avatarModalTitle">
        <div class="modal-header">
          <h3 id="avatarModalTitle">Choose avatar</h3>
          <button type="button" id="avatarModalClose" class="icon-btn" aria-label="Close">Ã—</button>
        </div>
        <div class="modal-body">
          <p class="tiny" style="margin-bottom:8px">
            Pick a character. Weâ€™ll use this across groups and leaderboards.
          </p>
          <div id="avatarGrid" class="avatars" role="listbox" aria-label="Choose avatar"></div>
        </div>
        <div class="modal-footer">
          <button type="button" id="avatarModalDone" class="btn btn-primary">Done</button>
        </div>
      </div>
    </div>

  </main>

  <!-- Bottom nav -->
  <nav class="bottom" aria-label="Primary">
    <a href="index.html"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 10.5L12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1v-10.5Z" stroke-width="1.5"/></svg><span>Home</span></a>
    <a href="learn.html"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 6h16M4 12h16M4 18h9" stroke-width="1.5" stroke-linecap="round"/></svg><span>Learn</span></a>
    <a href="manage_sets/"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="4" width="18" height="16" rx="2" ry="2" stroke-width="1.5"/><path d="M7 8h10M7 12h10M7 16h7" stroke-width="1.5" stroke-linecap="round"/></svg><span>Library</span></a>
    <a href="dashboard.html"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 14h6V4H4v10Zm10 6h6V4h-6v16Z" stroke-width="1.5"/></svg><span>Dashboard</span></a>
    <a href="groups.html"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="8" cy="8" r="3" stroke-width="1.5"/><path d="M2 20v-1c0-3 3-5 6-5" stroke-width="1.5" stroke-linecap="round"/><circle cx="16" cy="10" r="3" stroke-width="1.5"/><path d="M11 20v-1c0-2.5 2.5-4.5 5-5" stroke-width="1.5" stroke-linecap="round"/></svg><span>Groups</span></a>
  </nav>

  <!-- Load runtime config first, then API helpers -->
  <script src="static/js/app-config.js"></script>
  <script src="static/js/api.js"></script>
  <script src="static/js/avatar.js"></script>

  <script>
    // Require sign-in (redirects to login.html on 401)
    (async () => { await api.requireAuth('login.html'); })();

    function shortDate(iso){
      if(!iso) return 'â€”';
      const d = new Date(iso);
      return d.toLocaleDateString();
    }
    function msg(el, t){
      if (!el) return;
      el.textContent = t;
      setTimeout(()=>{ el.textContent=''; }, 1800);
    }

    function loadLocalProfile(){
      try { return JSON.parse(localStorage.getItem('lp.profile') || '{}'); } catch(_){ return {}; }
    }
    function saveLocalProfile(obj){
      try { localStorage.setItem('lp.profile', JSON.stringify(obj||{})); } catch(_){}
    }

    // Global state for this page
    const state = {
      avatar_id: null,
      weekly_goal: 500,
      study_mode: "path" // "path" | "self"
    };

    // -------- Goals: study mode & weekly goal --------
    function resolveStudyModeFromProfile(loc, weeklyGoalValue) {
      const src = loc || {};
      const fromProfile = (typeof src.study_mode === "string")
        ? src.study_mode.toLowerCase()
        : null;

      if (fromProfile === "self" || fromProfile === "path") {
        return fromProfile;
      }

      // Heuristic for older profiles: 500 â†’ path, anything else â†’ self-paced
      const goal = Number(weeklyGoalValue || src.weekly_goal || 500) || 500;
      return goal === 500 ? "path" : "self";
    }

    function applyGoalModeUI(mode) {
      const normalized = (mode === "self" || mode === "path") ? mode : "path";
      state.study_mode = normalized;

      const weeklyGoalInput = document.getElementById("weeklyGoal");
      const goalHint = document.getElementById("goalHint");
      const buttons = document.querySelectorAll(".goal-mode-btn");

      buttons.forEach(btn => {
        const m = (btn.dataset.mode || "").toLowerCase();
        const active = m === normalized;
        btn.classList.toggle("btn-primary", active);
      });

      if (!weeklyGoalInput || !goalHint) return;

      if (normalized === "path") {
        weeklyGoalInput.value = 500;
        weeklyGoalInput.disabled = true;
        weeklyGoalInput.readOnly = true;
        goalHint.textContent = "Admin-set Path to POLISH goal (500 gold/week, game mode bonuses).";
      } else {
        weeklyGoalInput.disabled = false;
        weeklyGoalInput.readOnly = false;
        goalHint.textContent = "Set your own target. No bonus streaks, just progress.";
      }
    }

    function wireGoalMode(loc) {
      const weeklyGoalInput = document.getElementById("weeklyGoal");
      const buttons = document.querySelectorAll(".goal-mode-btn");
      if (!weeklyGoalInput || !buttons.length) return;

      const initialMode = resolveStudyModeFromProfile(loc || {}, weeklyGoalInput.value);
      applyGoalModeUI(initialMode);

      buttons.forEach(btn => {
        btn.addEventListener("click", () => {
          const m = (btn.dataset.mode || "").toLowerCase();
          if (m !== "self" && m !== "path") return;
          applyGoalModeUI(m);
        });
      });
    }

    // -------- Init profile (server + local) --------
    async function initProfile(){
      let me = null;
      try {
        const r = await api.fetch('/api/me');
        if (r.ok) me = await r.json();
      } catch (_) {}

      const loc = loadLocalProfile();

      // Decide initial avatar (server â†’ local â†’ default)
      const initialAvatar = (me && me.avatar_id) || loc.avatar_id || 'scout';
      state.avatar_id = initialAvatar;

      // Wire avatar chooser modal (from avatar.js)
      if (window.AvatarChooser && typeof AvatarChooser.initProfileAvatar === 'function') {
        AvatarChooser.initProfileAvatar({
          initialId: initialAvatar,
          onChange: (id) => {
            state.avatar_id = id;
            // keep local profile in sync so other pages can read it
            try {
              const prof = loadLocalProfile() || {};
              prof.avatar_id = id;
              saveLocalProfile(prof);
            } catch (_) {}
          }
        });
      } else {
        // Fallback: just show the emoji
        const big = document.getElementById('avatarBig');
        if (big) big.textContent = 'ðŸ™‚';
      }

      // Basic profile fields
      const nameVal =
        (me && (me.display_name || me.name)) ||
        loc.display_name ||
        "";
      const emailVal = (me && me.email) || loc.email || "";

      const nameInput = document.getElementById('displayName');
      const emailInput = document.getElementById('email');
      const joinEl = document.getElementById('joinDate');

      if (nameInput) nameInput.value = nameVal;
      if (emailInput) emailInput.value = emailVal;
      if (joinEl) joinEl.textContent = 'Joined ' + shortDate((me && me.created_at) || loc.created_at);

      // Weekly goal from stats (if available), else local
      const weeklyGoalInput = document.getElementById('weeklyGoal');

      try {
        const r = await api.fetch('/api/my/stats');
        if (r.ok) {
          const s = await r.json();
          const goal = Number(s.goal_points || s.goal_gold || loc.weekly_goal || 500) || 500;
          if (weeklyGoalInput) weeklyGoalInput.value = goal;
          state.weekly_goal = goal;
        } else {
          if (weeklyGoalInput) weeklyGoalInput.value = loc.weekly_goal || 500;
          state.weekly_goal = Number((weeklyGoalInput && weeklyGoalInput.value) || loc.weekly_goal || 500) || 500;
        }
      } catch(_) {
        if (weeklyGoalInput) weeklyGoalInput.value = loc.weekly_goal || 500;
        state.weekly_goal = Number((weeklyGoalInput && weeklyGoalInput.value) || loc.weekly_goal || 500) || 500;
      }

      // Initialize goal mode selector from profile + weekly goal
      wireGoalMode(loc);

      // UI language
      const uiLang = (loc.ui_lang || 'en');
      const uiLangEl = document.getElementById('uiLang');
      if (uiLangEl) uiLangEl.value = uiLang;

      // TTS prefs from local profile (no DB dependency)
      const tprov = (loc.tts_provider || '').toLowerCase();   // 'azure' | 'gtts' | ''
      const tvox  = (loc.tts_voice || '');
      const choiceEl = document.getElementById('ttsChoice');

      if (choiceEl) {
        let val = '';

        if (tprov === 'azure') {
          if (/zofia/i.test(tvox)) {
            val = 'azure:pl-PL-ZofiaNeural';
          } else if (/marek/i.test(tvox)) {
            val = 'azure:pl-PL-MarekNeural';
          }
        } else if (tprov === 'gtts') {
          val = 'gtts:pl';
        }

        // Default if nothing stored yet
        choiceEl.value = val || 'azure:pl-PL-MarekNeural';
      }
    }

    // -------- Unified Save & exit (whole profile) --------
    document.getElementById('saveBtn').addEventListener('click', async () => {
      const saveMsg = document.getElementById('saveMsg');
      const weeklyInput = document.getElementById('weeklyGoal');
      const mode = (state.study_mode === 'self' || state.study_mode === 'path')
        ? state.study_mode
        : 'path';

      let weeklyGoal = Number(weeklyInput && weeklyInput.value) || 500;
      if (mode === 'path') {
        weeklyGoal = 500;
        if (weeklyInput) weeklyInput.value = 500;
      }

      const displayName = (document.getElementById('displayName').value || '').trim();
      const emailVal = (document.getElementById('email') && document.getElementById('email').value) || '';
      const uiLangEl = document.getElementById('uiLang');
      const choiceEl = document.getElementById('ttsChoice');

      // Derive TTS provider/voice from current dropdown
      let ttsProvider = '';
      let ttsVoice = '';
      if (choiceEl) {
        const raw = choiceEl.value || '';
        if (raw.startsWith('azure:')) {
          ttsProvider = 'azure';
          ttsVoice = raw.slice('azure:'.length); // e.g. pl-PL-MarekNeural
        } else if (raw.startsWith('gtts:')) {
          ttsProvider = 'gtts';
          ttsVoice = ''; // implied single Polish voice
        }
      }

      // Pronunciation difficulty â€“ prefer global userPrefs, then local profile
      const loc = loadLocalProfile() || {};
      let pronDifficulty = 'normal';
      try {
        pronDifficulty =
          (window.userPrefs && window.userPrefs.pronDifficulty) ||
          (loc.preferences && loc.preferences.pronDifficulty) ||
          'normal';
      } catch (_) {}
      pronDifficulty = String(pronDifficulty || 'normal').toLowerCase();
      if (pronDifficulty !== 'easy' && pronDifficulty !== 'normal' && pronDifficulty !== 'hard') {
        pronDifficulty = 'normal';
      }

      // Build server payload (only fields we know it accepts)
      const body = {
        display_name: displayName,
        name: displayName,
        weekly_goal: weeklyGoal,
        study_mode: mode,
        avatar_id: state.avatar_id,
        ui_lang: uiLangEl ? uiLangEl.value : 'en'
        // tts_* and preferences are kept local; server may ignore or reject them
      };

      let ok = false;
      try {
        const r = await api.fetch('/api/me', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        ok = r.ok;
      } catch (_) {}

      state.weekly_goal = weeklyGoal;
      state.study_mode = mode;

      // Merge + persist full local profile snapshot
      const prefs = (loc.preferences && typeof loc.preferences === 'object')
        ? Object.assign({}, loc.preferences)
        : {};
      prefs.pronDifficulty = pronDifficulty;

      const merged = Object.assign({}, loc, body, {
        email: emailVal,
        created_at: loc.created_at || new Date().toISOString(),
        tts_provider: ttsProvider,
        tts_voice: ttsVoice,
        preferences: prefs
      });

      saveLocalProfile(merged);

      // Keep global userPrefs in sync
      try {
        window.userPrefs = window.userPrefs || {};
        window.userPrefs.pronDifficulty = pronDifficulty;
      } catch (_) {}

      msg(saveMsg, ok ? 'Saved!' : 'Saved locally (offline)');
      // Exit after a short delay so the user sees the toast
      setTimeout(() => {
        window.location.href = 'dashboard.html';
      }, 350);
    });

    // -------- Cancel (exit without extra writes) --------
    document.getElementById('cancelBtn').addEventListener('click', () => {
      // Just leave the page; local pron-diff may already be updated by chips,
      // but we don't touch lp.profile or call the API here.
      window.location.href = 'dashboard.html';
    });

    // --- Pronunciation difficulty prefs (local only, shared across modes) ---
    (function () {
      const root = document.getElementById('pronDiffChips');
      if (!root) return;

      // Read current profile from localStorage
      let prof = loadLocalProfile() || {};
      const prefs = (prof.preferences && typeof prof.preferences === 'object')
        ? prof.preferences
        : {};

      // Prefer global userPrefs (from app-config.js), then local preferences
      let current = (
        (window.userPrefs && window.userPrefs.pronDifficulty) ||
        prefs.pronDifficulty ||
        'normal'
      ).toLowerCase();

      if (current !== 'easy' && current !== 'normal' && current !== 'hard') {
        current = 'normal';
      }

      function syncUI() {
        root.querySelectorAll('.diff-pref').forEach(btn => {
          const d = (btn.dataset.diff || 'normal').toLowerCase();
          btn.classList.toggle('active', d === current);
        });
      }

      // Initialize UI + global userPrefs
      try {
        window.userPrefs = window.userPrefs || {};
        window.userPrefs.pronDifficulty = current;
      } catch (_) {}
      syncUI();

      root.addEventListener('click', (ev) => {
        const btn = ev.target.closest('.diff-pref');
        if (!btn) return;

        const d = (btn.dataset.diff || '').toLowerCase();
        if (d !== 'easy' && d !== 'normal' && d !== 'hard') return;

        current = d;
        syncUI();

        // Update local profile immediately so other pages can read it
        try {
          prof = loadLocalProfile() || {};
          if (!prof.preferences || typeof prof.preferences !== 'object') {
            prof.preferences = {};
          }
          prof.preferences.pronDifficulty = current;
          saveLocalProfile(prof);
        } catch (_e) {}

        // Update global userPrefs for this page
        try {
          window.userPrefs = window.userPrefs || {};
          window.userPrefs.pronDifficulty = current;
        } catch (_e) {}
      });
    })();

    // -------- Logout --------
    document.getElementById('logoutBtn').addEventListener('click', async ()=>{
      try{ await api.fetch('/api/logout', {method:'POST'});}catch(_){}
      api.clearToken();
      location.href = 'login.html';
    });

    // -------- Delete account --------
    document.getElementById('deleteBtn').addEventListener('click', async ()=>{
      if(!confirm('Delete your account? This cannot be undone.')) return;
      try{
        const r = await api.fetch('/api/me', { method:'DELETE' });
        if(r.ok){
          alert('Account deleted');
          localStorage.clear();
          location.href='register.html';
        } else {
          alert('Server refused deletion');
        }
      }catch(_){
        alert('Deletion failed');
      }
    });

    // Kick things off
    initProfile();
  </script>

</body>
</html>
