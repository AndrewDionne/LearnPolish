<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <script>
    (function () {
      var isGH = /\.github\.io$/i.test(location.hostname);
      var baseHref = isGH ? '/LearnPolish/' : '/';
      document.write('<base href="' + baseHref + '">');
    })();
  </script>
  <title>Session Summary • Path to POLISH</title>
  <link rel="stylesheet" href="static/app.css?v=9"/>
  <style>
    :root{
      --gold:#c58b0f;
    }
    .wrap{max-width:900px;margin:0 auto 92px;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin:16px 0;box-shadow:var(--shadow,0 1px 2px rgba(8,15,52,.04))}
    .card.card-compact{padding:10px 16px;}
    .row{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .kv{display:grid;grid-template-columns:auto 1fr;column-gap:12px;row-gap:4px;font-size:14px}
    .kv>div:nth-child(odd){color:var(--muted)}
    .big{font-size:22px;font-weight:600}
    .bar{position:relative;width:100%;height:10px;border-radius:999px;background:var(--border);overflow:hidden;margin:8px 0 4px}
    .bar-inner{height:100%;width:0%;background:var(--gold);transition:width .4s ease}
    .gold-pill{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(197,139,15,.3);
      background:rgba(197,139,15,.06);
      font-size:13px;
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:190px;
    }
    .gold-pill strong{font-weight:600}
    .gold-coin{
      display:inline-block;
      width:14px;
      height:14px;
      border-radius:50%;
      background:var(--gold);
      box-shadow:0 0 0 1px rgba(0,0,0,.18);
      margin-right:4px;
      vertical-align:middle;
    }
    .gold-coin.small{
      width:10px;
      height:10px;
      margin-right:0;
    }
    .gold-coin.weekly{
      width:20px;
      height:20px;
      margin-left:8px;
    }
    .gold-coin.unearned{
      background:#d4d4e3;
      box-shadow:0 0 0 1px rgba(0,0,0,.2);
    }
    .muted-small{font-size:12px;color:var(--muted)}
    table.breakdown{width:100%;border-collapse:collapse;font-size:14px}
    table.breakdown td{padding:6px 4px;border-bottom:1px solid #ececf5;text-align:left}
    table.breakdown td.score{text-align:right;white-space:nowrap}
    table.breakdown td.score.is-perfect{color:var(--gold);font-weight:600}
    table.breakdown td.coin{text-align:center;width:40px}

    @keyframes gold-pop {
      0%   {transform:scale(0.8);}
      60%  {transform:scale(1.2);}
      100% {transform:scale(1);}
    }
    .pop {
      animation: gold-pop 0.4s ease-out;
    }
  </style>
</head>
<body
  data-header="Path to Polish"
  data-note-lead="Summary"
  data-note-tail="">

  <header class="topbar no-nav">
    <div class="row container">
      <div class="header-left">
        <a class="brand" href="index.html" aria-label="Path to Polish — Home">
          <svg class="brand-mark" aria-hidden="true" focusable="false">
            <use href="static/brand.svg#ptp-mark"></use>
          </svg>
          <span id="headerBanner" class="header-banner">Session summary</span>
        </a>
      </div>
      <nav class="head-actions">
        <a href="profile.html"  id="profileBtn">Profile</a>
        <a href="login.html"    id="loginLink">Sign In</a>
        <a href="register.html" id="registerLink">Register</a>
        <button id="logoutBtn" style="display:none;">Logout</button>
      </nav>
    </div>
  </header>

  <div class="wrap page-note-wrap">
    <div id="pageNote" class="page-note"></div>
  </div>

  <main class="wrap">
    <!-- Result + gold -->
    <section class="card">
      <div class="row">
        <div style="flex:1 1 260px;min-width:0;">
          <h2 style="margin:0 0 4px">Result</h2>
          <div id="topLine" class="big">Loading…</div>
          <div class="kv" style="margin-top:8px">
            <div class="muted">Number of cards</div><div id="cardCount">—</div>
            <div class="muted">Perfect cards</div><div id="perfectInfo">—</div>
          </div>
        </div>
        <div style="flex:0 0 220px;display:flex;justify-content:flex-end">
          <div class="gold-pill">
            <div><span class="gold-coin"></span><strong>Gold</strong></div>
            <div id="goldRunLine" class="muted-small">This run: —</div>
            <div id="goldTotalLine" class="muted-small">Gold earned: —</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Try again (own compact card) -->
    <section class="card card-compact">
      <div class="row" style="justify-content:flex-start;">
        <a id="againBtn" class="btn btn-primary" href="learn.html">Try again</a>
      </div>
    </section>

    <!-- Weekly progress -->
    <section class="card">
      <h3 style="margin-top:0">Weekly progress</h3>
      <div id="progressLine" class="row" style="margin-bottom:4px"></div>
      <div class="row" style="align-items:center;gap:8px;">
        <div class="bar"><div id="wbar" class="bar-inner"></div></div>
        <span id="weeklyCoin" class="gold-coin weekly unearned" aria-label="Weekly goal bonus"></span>
      </div>
      <div class="row" style="margin-top:4px;align-items:flex-end">
        <div id="wtext">0 / 500</div>
      </div>
    </section>

    <!-- Breakdown -->
    <section id="breakdownCard" class="card" style="display:none;">
      <h3 style="margin-top:0;margin-bottom:8px;">Breakdown</h3>
      <div id="breakdownEmpty" class="muted-small" style="display:none;">No per-card data is available for this session.</div>
      <div id="breakdownWrap" style="overflow-x:auto;">
        <table class="breakdown">
          <tbody id="breakdownBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <nav class="bottom" aria-label="Primary">
    <a href="index.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1V10.5Z"/></svg>
      <span>Home</span>
    </a>
    <a href="learn.html" class="active" aria-current="page">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 6h16M4 12h10M4 18h7" stroke-linecap="round"/></svg>
      <span>Learn</span>
    </a>
    <a href="manage_sets/index.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 5h16v4H4zM4 11h10v4H4zM4 17h7v4H4z"/></svg>
      <span>Library</span>
    </a>
    <a href="dashboard.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 14h6V4H4zm10 0h6V4h-6zm0 6h6v-4h-6zM4 20h6v-2H4z"/></svg>
      <span>Dashboard</span>
    </a>
    <a href="groups.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 11a4 4 0 1 1 4-4 4 4 0 0 1-4 4Zm8 0a3 3 0 1 0-3-3 3 3 0 0 0 3 3ZM4 21v-1a5 5 0 0 1 5-5h2a5 5 0 0 1 5 5v1Zm10.5 0A3.5 3.5 0 0 1 21 17.5V17a4 4 0 0 0-3.5-4"/></svg>
      <span>Groups</span>
    </a>
  </nav>

  <script src="static/js/app-config.js"></script>
  <script src="static/js/api.js"></script>
  <script src="static/js/page-chrome.js"></script>
  <script>
  (function(){
    function qp(k){ return new URLSearchParams(location.search).get(k) || ''; }

    // Simple number animation helper
    function animateNumber(el, from, to, duration, formatFn){
      if (!el) return;
      from = Number(from) || 0;
      to   = Number(to)   || 0;
      if (duration <= 0 || from === to){
        el.textContent = formatFn(to);
        return;
      }
      const start = performance.now();
      function frame(now){
        const t = Math.min(1, (now - start) / duration);
        const val = Math.round(from + (to - from) * t);
        el.textContent = formatFn(val);
        if (t < 1) requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);
    }

    // Query params
    const q = {
      set:   qp('set'),
      mode: (qp('mode')||'').toLowerCase(),
      score: Number(qp('score')||0),
      awarded: (function(){ const v = qp('awarded'); return v ? Number(v) : null; })()
    };

    // Last result from sessionStorage
    let last = null;
    try { last = JSON.parse(sessionStorage.getItem('lp.lastResult') || 'null'); } catch(_){}

    if (!q.set && last){
      q.set   = last.set   || q.set;
      q.mode  = (last.mode || q.mode || '').toLowerCase();
      if (!q.score && last.score != null) q.score = Number(last.score) || 0;
    }

    const setNameRaw = q.set || (last && last.set) || '';
    const modeRaw    = q.mode || (last && last.mode) || '';
    const scoreRaw   = (Number.isFinite(q.score) ? q.score : 0);
    const details    = last && typeof last.details === 'object' ? last.details : null;

    function normMode(m){
      m = (m||'').toLowerCase();
      if (m===''||m==='learn'||m==='vocab'||m==='flashcard'||m==='flashcards') return 'flashcards';
      if (m==='speak'||m==='practice') return 'practice';
      if (m==='read'||m==='reading')   return 'reading';
      if (m==='listen'||m==='listening') return 'listening';
      return 'flashcards';
    }

    const modeNorm   = normMode(modeRaw);
    const setName    = setNameRaw || '—';
    const scorePct   = Math.max(0, Math.round(scoreRaw || 0));

    const cardCountEl= document.getElementById('cardCount');
    const perfectEl  = document.getElementById('perfectInfo');
    const topLine    = document.getElementById('topLine');

    // ---- derive card stats (for flashcards; others fallback) ----
    let totalCards = null;
    let n100 = null;
    let avgCardScore = null;
    let highestCardScore = null;

    if (details && typeof details === 'object'){
      if (details.total != null) {
        const t = Number(details.total);
        if (Number.isFinite(t) && t > 0) totalCards = t;
      }
      if (details.n100 != null) {
        const v = Number(details.n100);
        if (Number.isFinite(v) && v >= 0) n100 = v;
      }
      if (details.avg_card_score != null) {
        const v = Number(details.avg_card_score);
        if (Number.isFinite(v) && v >= 0) avgCardScore = v;
      }
      // Try to compute avg/highest from per-card stats if present
      if (!avgCardScore && details.per && typeof details.per === 'object') {
        let sum = 0, count = 0, hi = 0;
        Object.values(details.per).forEach(function(r){
          const b = Number(r && r.best);
          if (!Number.isFinite(b)) return;
          sum += b; count += 1;
          if (b > hi) hi = b;
        });
        if (count > 0) {
          avgCardScore = sum / count;
          highestCardScore = hi;
        }
      }
    }

    if (!totalCards && details && typeof details.total === 'number'){
      totalCards = details.total;
    }

    if (cardCountEl) {
      cardCountEl.textContent = totalCards ? String(totalCards) : '—';
    }

    let perfectText = '—';
    if (n100 != null && totalCards) {
      perfectText = n100 + ' / ' + totalCards;
    } else if (n100 != null) {
      perfectText = String(n100);
    } else if (highestCardScore != null) {
      perfectText = 'Highest card: ' + Math.round(highestCardScore) + '%';
    }
    if (perfectEl) perfectEl.textContent = perfectText;

    // ---- Top line: animate score 0 → displayScore ----
    (function(){
      if (!topLine) return;
      const displayScore = (avgCardScore != null)
        ? Math.round(avgCardScore)
        : (scorePct || 0);
      const label = setNameRaw ? (' • ' + setNameRaw) : '';
      if (!displayScore) {
        topLine.textContent = setNameRaw || '—';
        return;
      }
      animateNumber(
        topLine,
        0,
        displayScore,
        700,
        function(v){ return v + '%' + label; }
      );
    })();

    // ---- "Try again" link ----
    (function(){
      const btn = document.getElementById('againBtn');
      if (!btn) return;
      const enc = encodeURIComponent(setNameRaw || '');
      if (!enc){
        btn.href = 'learn.html';
        return;
      }
      if (modeNorm === 'reading')        btn.href = `reading/${enc}/`;
      else if (modeNorm === 'listening') btn.href = `listening/${enc}/`;
      else if (modeNorm === 'practice')  btn.href = `practice/${enc}/`;
      else                               btn.href = `flashcards/${enc}/`;
    })();

    // ---- Gold for this run ----
    function goldFromDetails(score, det){
      if (det && typeof det === 'object'){
        const primary = ['gold_awarded','points_awarded'];
        for (const k of primary){
          if (Object.prototype.hasOwnProperty.call(det, k)){
            const v = Number(det[k]);
            if (Number.isFinite(v)) return Math.max(0, Math.round(v));
          }
        }
        const secondary = ['gold_rounded','gold_raw','gold','points_total'];
        for (const k of secondary){
          if (Object.prototype.hasOwnProperty.call(det, k)){
            const v = Number(det[k]);
            if (Number.isFinite(v)) return Math.max(0, Math.round(v));
          }
        }
      }
      return Math.max(0, Math.round(score || 0));
    }

    let runGold = null;
    if (q.awarded != null && Number.isFinite(q.awarded)) {
      runGold = Math.max(0, Math.round(q.awarded));
    } else if (details) {
      runGold = goldFromDetails(scorePct, details);
    }

    const goldRunLine   = document.getElementById('goldRunLine');
    const goldTotalLine = document.getElementById('goldTotalLine');

    // Static initial text (will be overridden by animation if stats load)
    if (goldRunLine) {
      goldRunLine.textContent = runGold != null
        ? `This run: +${runGold}`
        : `This run: —`;
    }

    // ---- Breakdown table (card list) ----
    function buildBreakdown(){
      const card = document.getElementById('breakdownCard');
      const body = document.getElementById('breakdownBody');
      const empty = document.getElementById('breakdownEmpty');
      if (!card || !body || !empty) return;
      body.innerHTML = '';

      const per = details && details.per && typeof details.per === 'object'
        ? details.per
        : null;

      if (!per) {
        empty.style.display = 'block';
        card.style.display = 'block';
        return;
      }

      const entries = Object.entries(per);
      if (!entries.length) {
        empty.style.display = 'block';
        card.style.display = 'block';
        return;
      }

      empty.style.display = 'none';
      card.style.display = 'block';

      entries.forEach(function([key, r], idx){
        const tr = document.createElement('tr');

        // Card label: "1. phrase"
        const labelCell = document.createElement('td');
        const rawLabel = (r && (r.label || r.text || r.phrase)) || key || ('Card ' + (idx+1));
        let label = String(rawLabel);
        if (label.length > 48) label = label.slice(0, 45) + '…';
        labelCell.textContent = (idx + 1) + '. ' + label;

        // Best score (gold when 100%)
        const bestCell = document.createElement('td');
        bestCell.className = 'score';
        const best = Number(r && r.best);
        if (Number.isFinite(best)) {
          bestCell.textContent = Math.round(best) + '%';
          if (best >= 100) bestCell.classList.add('is-perfect');
        } else {
          bestCell.textContent = '—';
        }

        // Gold coin if perfect
        const coinCell = document.createElement('td');
        coinCell.className = 'coin';
        if (Number.isFinite(best) && best >= 100) {
          coinCell.innerHTML = '<span class="gold-coin small"></span>';
        } else {
          coinCell.textContent = '○';
        }

        tr.appendChild(labelCell);
        tr.appendChild(bestCell);
        tr.appendChild(coinCell);
        body.appendChild(tr);
      });
    }

    buildBreakdown();

    // ---- Weekly progress bar ----
    async function refreshWeeklyBar(){
      const wbar   = document.getElementById('wbar');
      const wtext  = document.getElementById('wtext');
      const pline  = document.getElementById('progressLine');
      const wcoin  = document.getElementById('weeklyCoin');

      try{
        const r = await api.fetch('/api/my/stats');
        if (!r.ok) {
          if (goldTotalLine) goldTotalLine.textContent = 'Gold earned: —';
          return;
        }
        const s = await r.json();

        const weekly = Number(s.weekly_gold ?? s.weekly_points ?? 0) || 0;
        const goal   = Number(s.goal_gold   ?? s.goal_points   ?? 500) || 500;
        const total  = Number(s.total_gold  ?? 0) || 0;

        const pct = goal > 0
          ? Math.max(0, Math.min(100, Math.round((weekly/goal)*100)))
          : 0;

        // Approximate "before this run" weekly value so we can animate
        const baseWeekly = Math.max(0, weekly - (runGold || 0));
        const basePct = goal > 0
          ? Math.max(0, Math.min(100, Math.round((baseWeekly/goal)*100)))
          : 0;

        if (pline) pline.textContent = `This week: ${weekly} gold`;

        // Animate weekly number
        if (wtext) {
          animateNumber(
            wtext,
            baseWeekly,
            weekly,
            800,
            function(v){ return v + ' / ' + goal; }
          );
        }

        // Animate bar width (base → final)
        if (wbar) {
          wbar.style.transition = 'none';
          wbar.style.width = basePct + '%';
          requestAnimationFrame(function(){
            wbar.style.transition = '';
            wbar.style.width = pct + '%';
          });
        }

        // Weekly bonus coin
        if (wcoin) {
          if (weekly >= goal) {
            wcoin.classList.remove('unearned');
            wcoin.classList.add('pop');
            setTimeout(function(){ wcoin.classList.remove('pop'); }, 500);
          } else {
            wcoin.classList.add('unearned');
          }
        }

        // Animate "This run" line if we know runGold
        if (goldRunLine) {
          if (runGold != null && runGold > 0) {
            animateNumber(
              goldRunLine,
              0,
              runGold,
              600,
              function(v){ return 'This run: +' + v; }
            );
          } else if (runGold != null) {
            goldRunLine.textContent = 'This run: +' + runGold;
          } else {
            goldRunLine.textContent = 'This run: —';
          }
        }

        // Animate "Gold earned" total
        if (goldTotalLine) {
          if (Number.isFinite(total)) {
            const base = Math.max(0, total - (runGold || 0));
            if (total > base) {
              animateNumber(
                goldTotalLine,
                base,
                total,
                800,
                function(v){ return 'Gold earned: ' + v; }
              );
            } else {
              goldTotalLine.textContent = 'Gold earned: ' + total;
            }
          } else {
            goldTotalLine.textContent = 'Gold earned: —';
          }
        }
      }catch(_){
        if (goldTotalLine) goldTotalLine.textContent = 'Gold earned: —';
      }
    }

    (async function run(){
      await refreshWeeklyBar();
    })();
  })();
  </script>
</body>
</html>
