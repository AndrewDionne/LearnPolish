<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <script>
    (function () {
      var isGH = /\.github\.io$/i.test(location.hostname);
      var baseHref = isGH ? '/LearnPolish/' : '/';
      document.write('<base href="' + baseHref + '">');
    })();
  </script>
  <title>Session Summary • Path to POLISH</title>
  <link rel="stylesheet" href="static/app.css?v=5"/>
  <style>
    .wrap{max-width:900px;margin:0 auto 92px;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;margin:16px 0}
    .row{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap}
    .kv{display:grid;grid-template-columns:auto 1fr;column-gap:12px;row-gap:4px;font-size:14px}
    .kv>div:nth-child(odd){color:var(--muted)}
    .big{font-size:22px;font-weight:600}
    .bar{position:relative;width:100%;height:10px;border-radius:999px;background:var(--border);overflow:hidden;margin:8px 0 4px}
    .bar-inner{height:100%;width:0%;background:var(--brand);transition:width .4s ease}
    #progressHint{font-size:13px;color:var(--muted)}
  </style>
</head>
<body
  data-header="Path to Polish"
  data-note-lead="Summary"
  data-note-tail="">

  <header class="topbar no-nav">
    <div class="row container">
      <div class="header-left">
        <a class="brand" href="index.html" aria-label="Path to Polish — Home">
          <svg class="brand-mark" aria-hidden="true" focusable="false">
            <use href="static/brand.svg#ptp-mark"></use>
          </svg>
          <span id="headerBanner" class="header-banner">Session summary</span>
        </a>
      </div>
      <nav class="head-actions">
        <a href="profile.html"  id="profileBtn">Profile</a>
        <a href="login.html"    id="loginLink">Sign In</a>
        <a href="register.html" id="registerLink">Register</a>
        <button id="logoutBtn" style="display:none;">Logout</button>
      </nav>
    </div>
  </header>

  <div class="wrap page-note-wrap">
    <div id="pageNote" class="page-note"></div>
  </div>

  <main class="wrap">
    <section class="card">
      <h2 style="margin:0 0 8px">Result</h2>
      <div id="topLine" class="row"></div>
      <div class="kv" style="margin-top:8px">
        <div class="muted">Collection</div><div id="setName">—</div>
        <div class="muted">Mode</div><div id="mode">—</div>
        <div class="muted">Score</div><div id="score">—</div>
        <div class="muted">Gold earned</div><div id="gold">—</div>
        <div class="muted">Notes</div><div id="notes" class="muted">—</div>
      </div>
    </section>

    <section id="breakdownCard" class="card" style="display:none;">
      <h3 style="margin-top:0">Breakdown</h3>
      <pre id="breakdown" style="white-space:pre-wrap;margin:0"></pre>
    </section>

    <section class="card">
      <h3 style="margin-top:0">Progress</h3>
      <div id="progressLine" class="row"></div>
      <div class="bar"><div id="wbar" class="bar-inner"></div></div>
      <div class="row" style="margin-top:2px;align-items:flex-end">
        <div id="wtext">0 / 500</div>
        <div id="extras" class="muted"></div>
      </div>
      <div id="progressHint"></div>
    </section>

    <section class="card">
      <h3 style="margin-top:0">Next steps</h3>
      <div class="row" style="gap:8px;flex-wrap:wrap;">
        <a id="againBtn" class="btn btn-primary" href="learn.html">Try again</a>
        <a class="btn" href="index.html">Home</a>
        <a class="btn" href="dashboard.html">Dashboard</a>
      </div>
    </section>
  </main>

  <nav class="bottom" aria-label="Primary">
    <a href="index.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1V10.5Z"/></svg>
      <span>Home</span>
    </a>
    <a href="learn.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 6h16M4 12h10M4 18h7" stroke-linecap="round"/></svg>
      <span>Learn</span>
    </a>
    <a href="manage_sets/index.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 5h16v4H4zM4 11h10v4H4zM4 17h7v4H4z"/></svg>
      <span>Library</span>
    </a>
    <a href="dashboard.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 14h6V4H4zm10 0h6V4h-6zm0 6h6v-4h-6zM4 20h6v-2H4z"/></svg>
      <span>Dashboard</span>
    </a>
    <a href="groups.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M8 11a4 4 0 1 1 4-4 4 4 0 0 1-4 4Zm8 0a3 3 0 1 0-3-3 3 3 0 0 0 3 3ZM4 21v-1a5 5 0 0 1 5-5h2a5 5 0 0 1 5 5v1Zm10.5 0A3.5 3.5 0 0 1 21 17.5V17a4 4 0 0 0-3.5-4"/></svg>
      <span>Groups</span>
    </a>
  </nav>

  <script src="static/js/app-config.js"></script>
  <script src="static/js/api.js"></script>
  <script src="static/js/page-chrome.js"></script>
  <script src="static/js/finish.js"></script>
  <script>
  (function(){
    function qp(k){ return new URLSearchParams(location.search).get(k) || ''; }

    // Query params (from Results.goSummary)
    const q = {
      set:  qp('set'),
      mode: (qp('mode')||'').toLowerCase(),
      score: Number(qp('score')||0)
    };

    // Last result from sessionStorage (set by Results.submit)
    let last = null;
    try { last = JSON.parse(sessionStorage.getItem('lp.lastResult') || 'null'); } catch(_){}

    if (!q.set && last){
      q.set   = last.set   || q.set;
      q.mode  = (last.mode || q.mode || '').toLowerCase();
      if (!q.score && last.score != null) q.score = Number(last.score) || 0;
    }

    const setNameRaw = q.set || (last && last.set) || '';
    const modeRaw    = q.mode || (last && last.mode) || '';
    const scoreRaw   = (Number.isFinite(q.score) ? q.score : 0);
    const details    = last && typeof last.details === 'object' ? last.details : null;

    function normMode(m){
      m = (m||'').toLowerCase();
      if (m===''||m==='learn'||m==='vocab'||m==='flashcard'||m==='flashcards') return 'flashcards';
      if (m==='speak'||m==='practice') return 'practice';
      if (m==='read'||m==='reading')   return 'reading';
      if (m==='listen'||m==='listening') return 'listening';
      return 'flashcards';
    }

    const modeNorm = normMode(modeRaw);
    const prettyMode = modeNorm.charAt(0).toUpperCase() + modeNorm.slice(1);
    const setName = setNameRaw || '—';
    const scorePct = Math.max(0, Math.round(scoreRaw || 0));

    // ---- Gold calculation (prefer awarded gold from details, else score) ----
    function goldFromDetails(score, det){
      if (det && typeof det === 'object'){
        // 1) what actually got awarded (server-side)
        const primaryKeys = ['gold_awarded', 'points_awarded'];
        for (const k of primaryKeys){
          if (Object.prototype.hasOwnProperty.call(det, k)){
            const v = Number(det[k]);
            if (Number.isFinite(v)) return Math.max(0, Math.round(v));
          }
        }
        // 2) raw run gold estimates
        const secondaryKeys = ['gold_rounded','gold_raw','gold','points_total'];
        for (const k of secondaryKeys){
          if (Object.prototype.hasOwnProperty.call(det, k)){
            const v = Number(det[k]);
            if (Number.isFinite(v)) return Math.max(0, Math.round(v));
          }
        }
      }
      // 3) fallback: use score as gold
      return Math.max(0, Math.round(score || 0));
    }

    const gold = goldFromDetails(scorePct, details);

    // ---- Populate Result card ----
    const setEl   = document.getElementById('setName');
    const modeEl  = document.getElementById('mode');
    const scoreEl = document.getElementById('score');
    const goldEl  = document.getElementById('gold');
    const notesEl = document.getElementById('notes');
    const topLine = document.getElementById('topLine');

    if (setEl)   setEl.textContent   = setName;
    if (modeEl)  modeEl.textContent  = prettyMode;
    if (scoreEl) scoreEl.textContent = scorePct ? (scorePct + '%') : '—';
    if (goldEl)  goldEl.textContent  = gold ? String(gold) : '0';

    if (topLine){
      topLine.textContent = scorePct
        ? `${prettyMode} • ${setName} • ${scorePct}%`
        : `${prettyMode} • ${setName}`;
    }

    if (notesEl){
      const parts = [];
      if (details && typeof details === 'object'){
        if (typeof details.passage_index === 'number'){
          parts.push(`Passage ${details.passage_index + 1}`);
        }
        if (typeof details.avg_accuracy === 'number'){
          parts.push(`Avg. accuracy ${Math.round(details.avg_accuracy)}%`);
        }
        if (typeof details.wpm === 'number'){
          parts.push(`${Math.round(details.wpm)} wpm`);
        }
      }
      notesEl.textContent = parts.length ? parts.join(' • ') : '—';
    }

    // Optional raw breakdown preview
    (function(){
      const card = document.getElementById('breakdownCard');
      const pre  = document.getElementById('breakdown');
      if (!card || !pre || !details) return;
      let s;
      try { s = JSON.stringify(details, null, 2); }
      catch(e){ s = String(details); }
      if (s.length > 1500) s = s.slice(0, 1500) + "\n…";
      card.style.display = 'block';
      pre.textContent = s;
    })();

    // ---- "Try again" link ----
    (function(){
      const btn = document.getElementById('againBtn');
      if (!btn) return;
      const enc = encodeURIComponent(setNameRaw || '');
      if (!enc){
        btn.href = 'learn.html';
        return;
      }
      if (modeNorm === 'reading')        btn.href = `reading/${enc}/`;
      else if (modeNorm === 'listening') btn.href = `listening/${enc}/`;
      else if (modeNorm === 'practice')  btn.href = `practice/${enc}/`;
      else                               btn.href = `flashcards/${enc}/`;
    })();

    // ---- Submit score if needed (idempotent per day / set / mode / score) ----
    function keyFor(set, mode, score){
      return 'lp.posted.'+ btoa([set,mode,score,new Date().toDateString()].join('|'));
    }

    async function submitIfNeeded(){
      try{
        await api.requireAuth('login.html');
        const scoreInt = Math.max(0, Math.round(scoreRaw || 0));
        const k = keyFor(setNameRaw || '', modeNorm, scoreInt);
        if (sessionStorage.getItem(k)) return;

        const body = {
          set_name: setNameRaw || '',
          mode: modeNorm,
          score: scoreInt,
          attempts: 1,
          details: details || {}
        };
        if (Number.isFinite(gold) && gold > 0){
          body.gold = gold;
          if (body.details && typeof body.details === 'object'){
            body.details.gold_rounded = gold;
          }
        }

        const resp = await api.fetch('/api/submit_score', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        if (resp.ok){
          sessionStorage.setItem(k, '1');
        }
      }catch(_){}
    }

    // ---- Weekly progress bar ----
    async function refreshWeeklyBar(){
      try{
        const r = await api.fetch('/api/my/stats');
        if (!r.ok) return;
        const s = await r.json();
        const weekly = Number(s.weekly_gold ?? s.weekly_points ?? 0) || 0;
        const goal   = Number(s.goal_gold   ?? s.goal_points   ?? 500) || 500;
        const pct = Math.max(0, Math.min(100, Math.round((weekly/goal)*100)));

        const wbar  = document.getElementById('wbar');
        const wtext = document.getElementById('wtext');
        const pline = document.getElementById('progressLine');
        const phint = document.getElementById('progressHint');

        if (wbar)  wbar.style.width = pct + '%';
        if (wtext) wtext.textContent = `${weekly} / ${goal}`;
        if (pline) pline.textContent = `This week: ${weekly} gold`;
        if (phint) phint.textContent =
          `Streak: ${(s.streak_days||0)} day(s) • Best: ${(s.longest_streak||0)} day(s)`;

        const extras = document.getElementById('extras');
        if (extras){
          extras.textContent =
            `Streak: ${(s.streak_days||0)} day(s) • Best: ${(s.longest_streak||0)} day(s)`;
        }
      }catch(_){}
    }

    (async function run(){
      await submitIfNeeded();
      await refreshWeeklyBar();
    })();
  })();
  </script>

</body>
</html>
