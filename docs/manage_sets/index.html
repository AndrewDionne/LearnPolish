<!-- docs/manage_sets.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Manage Sets</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f8f9fa; padding: 2rem; }
    h1 { text-align: center; margin-bottom: 0.75rem; }
    .home-btn { position: absolute; top: 1rem; right: 1rem; background: #007bff; color: white; padding: 0.4rem 0.8rem; border-radius: 8px; text-decoration: none; font-size: 1rem; }

    .tabs { display: flex; justify-content: center; gap: 1rem; margin: 0.25rem 0 0.75rem; }
    .tab-btn { padding: 0.5rem 1.2rem; border: none; border-radius: 8px; background: #e0e0e0; cursor: pointer; font-size: 1rem; }
    .tab-btn.active { background: #007bff; color: white; }

    .toolbar { display:flex; align-items:center; gap:10px; justify-content:center; margin: 0.5rem 0 0.75rem; flex-wrap: wrap; }
    .search-bar input { width: 90%; max-width: 420px; padding: 0.5rem; border-radius: 6px; border: 1px solid #ccc; }

    table { width: 100%; border-collapse: collapse; background: white; }
    th, td { padding: 0.6rem; border-bottom: 1px solid #eee; text-align: center; }
    th { background: #f1f1f1; user-select: none; cursor: pointer; }
    th.sortable:hover { background:#e9eefb; }
    th .arrow { font-size: 0.85em; opacity: .7; margin-left: 4px; }

    .action-btn { padding: 4px 10px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.9rem; }
    .import-btn { background: #28a745; color: white; }
    .remove-btn { background: #dc3545; color: white; }
    .delete-link { background: none; border: none; font-size: 0.95rem; color: #b00020; cursor: pointer; text-decoration: underline; }
    tr.in-library { background: #e6ffe6; }

    .rating { display:inline-block; font-size: 1.1rem; letter-spacing: 2px; cursor: default; }
    .rating .star { cursor: pointer; }
    .muted { color:#666; font-size: 0.95rem; }
    #status { margin-top: 8px; min-height: 1.2em; color:#666; text-align:center; }

    /* Inline editor row */
    .edit-row td { background:#fafcff; }
    .edit-wrap { display:flex; gap:12px; align-items:center; justify-content:center; flex-wrap:wrap; padding:6px 0; }
    .edit-wrap textarea { width: 420px; max-width: 90vw; height: 70px; padding:6px; border-radius:6px; border:1px solid #ccc; }
    .btn { padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    .btn-primary { background:#2d6cdf; color:#fff; border-color:#2d6cdf; }
  </style>
</head>
<body>
  <h1>‚öôÔ∏è Manage Sets</h1>
  <a href="/" class="home-btn">üè† Home</a>

  <div class="tabs">
    <button class="tab-btn" data-tab="my">üìö My Collection</button>
    <button class="tab-btn" data-tab="global">üåç Global Library</button>
  </div>

  <div class="toolbar">
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Search sets..." />
    </div>
  </div>

  <table id="setsTable">
    <thead>
      <tr>
        <th class="sortable" data-key="name">Name <span class="arrow" id="sortName"></span></th>
        <th class="sortable" data-key="count">Cards <span class="arrow" id="sortCount"></span></th>
        <th class="sortable" data-key="type">Type <span class="arrow" id="sortType"></span></th>
        <th>Rating</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="status" class="muted"></div>

  <a href="/create_page" class="floating-btn">Ôºã New Set</a>

  <!-- unified API helper -->
  <script src="./static/js/api.js"></script>
  <script>
    // --- State ---
    let globalList = []; // [{name,count,type,created_by?}]
    let myList = [];     // [{name,count,type,is_owner?,created_by?}]
    let globalMap = new Map();
    let myMap = new Map();

    const els = {
      search: document.getElementById('searchInput'),
      table: document.getElementById('setsTable'),
      tbody: document.querySelector('#setsTable tbody'),
      tabs: document.querySelectorAll('.tab-btn'),
      status: document.getElementById('status'),
      sortName: document.getElementById('sortName'),
      sortCount: document.getElementById('sortCount'),
      sortType: document.getElementById('sortType'),
    };

    // Persisted UI state
    let activeTab = localStorage.getItem('lp.manage.tab') || 'my';
    let sortKey = localStorage.getItem('lp.manage.sortKey') || 'name';
    let sortDir = parseInt(localStorage.getItem('lp.manage.sortDir') || '1', 10); // 1=asc, -1=desc
    els.search.value = localStorage.getItem('lp.manage.q') || '';

    function setActiveTab(tab) {
      activeTab = tab;
      localStorage.setItem('lp.manage.tab', tab);
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
      renderTable();
    }

    function rebuildMaps() {
      globalMap = new Map(globalList.map(s => [s.name, s]));
      myMap = new Map(myList.map(s => [s.name, s]));
    }

    // --- Ratings (local for now; will POST if backend adds /api/sets/rate) ---
    function loadRatings() {
      try { return JSON.parse(localStorage.getItem('lp.setRatings') || '{}'); }
      catch { return {}; }
    }
    function saveRatings(map) {
      localStorage.setItem('lp.setRatings', JSON.stringify(map));
    }
    const ratings = loadRatings(); // { [name]: {stars, comment, ts} }

    function starsHtml(n) {
      const filled = '‚òÖ'.repeat(n || 0);
      const empty = '‚òÜ'.repeat(Math.max(0, 5 - (n || 0)));
      return filled + empty;
    }

    // --- Fetchers (prefer enriched legacy to get counts/types; fallback to new minimal) ---
    async function fetchGlobal() {
      // Prefer legacy enriched list for real counts/types
      let r = await api.fetch('/api/global_sets');
      if (r.ok) return r.json();

      // Fallback: new minimal list -> we‚Äôll mark unknowns accordingly
      r = await api.fetch('/api/sets/available');
      if (r.ok) {
        const arr = await r.json();
        return arr.map(x => ({ name: x.name, count: '?', type: 'unknown' }));
      }
      return [];
    }

    async function fetchMy() {
      // Prefer legacy enriched list (includes counts for private sets)
      let r = await api.fetch('/api/my_sets');
      if (r.status === 401) {
        alert('Please sign in to manage your sets.');
        location.href = '/login.html';
        return [];
      }
      if (r.ok) return r.json();

      // Fallback: new minimal -> merge with global to derive counts/types
      r = await api.fetch('/api/my/sets');
      if (r.ok) {
        const raw = await r.json();
        return raw.map(x => {
          const name = x.set_name || x.name || '';
          const g = globalMap.get(name);
          return {
            name,
            is_owner: !!x.is_owner,
            count: g?.count ?? '?',
            type: g?.type ?? 'unknown',
            created_by: x.is_owner ? 'me' : g?.created_by
          };
        });
      }
      return [];
    }

    async function loadSets() {
      try {
        els.status.textContent = 'Loading‚Ä¶';
        globalList = await fetchGlobal();
        rebuildMaps();
        myList = await fetchMy();
        rebuildMaps();
        els.status.textContent = '';
        renderTable();
      } catch (e) {
        console.error(e);
        els.status.textContent = 'Failed to load sets. Is the backend running?';
      }
    }

    // --- Utilities ---
    function numVal(v) {
      const n = typeof v === 'number' ? v : parseInt(v, 10);
      return Number.isFinite(n) ? n : Number.NEGATIVE_INFINITY;
    }
    function cmp(a, b, key) {
      const av = a[key], bv = b[key];
      if (key === 'count') {
        return (numVal(av) - numVal(bv)) || String(a.name).localeCompare(String(b.name));
      }
      return String(av || '').localeCompare(String(bv || ''), undefined, { sensitivity: 'base' });
    }
    function sortList(list) {
      const arr = list.slice().sort((a, b) => cmp(a, b, sortKey) * sortDir);
      els.sortName.textContent = sortKey === 'name' ? (sortDir > 0 ? '‚ñ≤' : '‚ñº') : '';
      els.sortCount.textContent = sortKey === 'count' ? (sortDir > 0 ? '‚ñ≤' : '‚ñº') : '';
      els.sortType.textContent = sortKey === 'type' ? (sortDir > 0 ? '‚ñ≤' : '‚ñº') : '';
      return arr;
    }
    function debounce(fn, ms) {
      let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
    }

    // --- Render (with inline rating editor row) ---
    function makeCell(text) {
      const td = document.createElement('td');
      td.textContent = text;
      return td;
    }

    function renderTable() {
      els.tbody.innerHTML = '';

      const q = els.search.value.toLowerCase().trim();
      const baseList = activeTab === 'my' ? myList : globalList;
      const filtered = baseList.filter(s => (s.name || '').toLowerCase().includes(q));
      const list = sortList(filtered);

      list.forEach(set => {
        const tr = document.createElement('tr');
        const inMyLib = myMap.has(set.name);
        const r = ratings[set.name] || {};

        tr.appendChild(makeCell(set.name));
        tr.appendChild(makeCell(set.count ?? '?'));
        tr.appendChild(makeCell(set.type ?? 'unknown'));

        // Rating display + "Rate" button
        const tdRate = document.createElement('td');
        const span = document.createElement('span');
        span.className = 'rating';
        span.textContent = starsHtml(r.stars || 0);
        tdRate.appendChild(span);

        const rateBtn = document.createElement('button');
        rateBtn.className = 'btn';
        rateBtn.dataset.set = set.name;
        rateBtn.textContent = 'Rate';
        tdRate.appendChild(document.createTextNode(' '));
        tdRate.appendChild(rateBtn);
        tr.appendChild(tdRate);

        // Actions
        const tdAct = document.createElement('td');
        if (activeTab === 'my') {
          // Always allow Remove (library only)
          const rm = document.createElement('button');
          rm.className = 'action-btn remove-btn';
          rm.dataset.set = set.name;
          rm.textContent = 'Remove';
          tdAct.appendChild(rm);

          // Owner: optional "Delete permanently"
          const isOwner = !!set.is_owner || set.created_by === 'me' || !globalMap.has(set.name);
          if (isOwner) {
            const del = document.createElement('button');
            del.className = 'delete-link';
            del.dataset.set = set.name;
            del.title = 'Delete the set file (use only for upload mistakes)';
            del.textContent = 'Delete permanently';
            tdAct.appendChild(document.createTextNode(' '));
            tdAct.appendChild(del);
          }
        } else {
          if (inMyLib) {
            const spanIn = document.createElement('span');
            spanIn.className = 'muted';
            spanIn.textContent = '‚úîÔ∏è In Library';
            tdAct.appendChild(spanIn);
          } else {
            const imp = document.createElement('button');
            imp.className = 'action-btn import-btn';
            imp.dataset.set = set.name;
            imp.textContent = 'Import';
            tdAct.appendChild(imp);
          }
        }
        tr.appendChild(tdAct);

        if (activeTab === 'global' && inMyLib) tr.classList.add('in-library');
        els.tbody.appendChild(tr);
      });
    }

    // Insert or toggle an inline editor row beneath a set row
    function toggleEditorRow(afterTr, setName) {
      const next = afterTr.nextElementSibling;
      if (next && next.classList.contains('edit-row')) {
        next.remove(); // close if already open
        return;
      }
      // Close any other editors
      document.querySelectorAll('.edit-row').forEach(n => n.remove());

      const r = ratings[setName] || { stars: 0, comment: '' };
      const tr = document.createElement('tr');
      tr.className = 'edit-row';
      const td = document.createElement('td');
      td.colSpan = 5;

      td.innerHTML = `
        <div class="edit-wrap" data-set="${setName}">
          <div class="rating" aria-label="Choose rating">
            ${[1,2,3,4,5].map(n => `<span class="star" data-val="${n}">${n <= (r.stars||0) ? '‚òÖ' : '‚òÜ'}</span>`).join('')}
          </div>
          <textarea placeholder="Leave a short comment...">${r.comment || ''}</textarea>
          <button class="btn btn-primary save-rating">Save</button>
          <button class="btn cancel-rating">Cancel</button>
          <span class="muted">(Saved locally for now)</span>
        </div>
      `;
      tr.appendChild(td);
      afterTr.insertAdjacentElement('afterend', tr);
    }

    // --- Actions (event delegation) ---
    els.table.addEventListener('click', async (ev) => {
      const btn = ev.target.closest('button');
      const cellStar = ev.target.classList.contains('star') ? ev.target : null;

      // Star click inside editor
      if (cellStar) {
        const wrap = cellStar.closest('.edit-wrap');
        if (!wrap) return;
        const val = parseInt(cellStar.dataset.val, 10);
        wrap.querySelectorAll('.star').forEach((s, i) => s.textContent = (i < val ? '‚òÖ' : '‚òÜ'));
        wrap.dataset.stars = String(val);
        return;
      }

      if (!btn) return;
      const setName = btn.dataset.set || (btn.closest('.edit-wrap')?.dataset.set);

      try {
        // Rate (open editor under row)
        if (btn.textContent === 'Rate') {
          const tr = btn.closest('tr');
          toggleEditorRow(tr, setName);
          return;
        }

        if (btn.classList.contains('save-rating')) {
          const wrap = btn.closest('.edit-wrap');
          const stars = parseInt(wrap.dataset.stars || '0', 10);
          const comment = wrap.querySelector('textarea').value.trim();
          // Try backend (optional / future)
          try {
            const r = await api.fetch('/api/sets/rate', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ set_name: setName, stars, comment })
            });
            // If 404/501, silently fall back to local
          } catch {}
          // Save locally
          ratings[setName] = { stars, comment, ts: Date.now() };
          saveRatings(ratings);
          // Update table rating stars
          const row = wrap.closest('tr').previousElementSibling;
          const ratingCell = row.children[3].querySelector('.rating');
          ratingCell.textContent = starsHtml(stars);
          // Close editor
          wrap.closest('.edit-row').remove();
          els.status.textContent = `Saved rating for "${setName}".`;
          return;
        }

        if (btn.classList.contains('cancel-rating')) {
          btn.closest('.edit-row').remove();
          return;
        }

        // Import
        if (btn.classList.contains('import-btn')) {
          let r = await api.fetch('/api/my/sets', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ set_name: setName })
          });
          if (!r.ok) {
            r = await api.fetch('/api/add_set', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ set_name: setName })
            });
          }
          if (!r.ok) throw new Error('import failed');

          const g = globalMap.get(setName) || { name: setName, count: '?', type: 'unknown' };
          myMap.set(setName, { name: setName, count: g.count, type: g.type, is_owner: false });
          myList = Array.from(myMap.values());
          rebuildMaps();
          renderTable();
          els.status.textContent = `Imported "${setName}".`;
          return;
        }

        // Remove (library only)
        if (btn.classList.contains('remove-btn')) {
          let r = await api.fetch(`/api/my/sets/${encodeURIComponent(setName)}`, { method: 'DELETE' });
          if (!r.ok) {
            r = await api.fetch('/api/remove_set', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ set_name: setName })
            });
          }
          if (!r.ok) throw new Error('remove failed');

          myMap.delete(setName);
          myList = Array.from(myMap.values());
          rebuildMaps();
          renderTable();
          els.status.textContent = `Removed "${setName}" from your library.`;
          return;
        }

        // Delete permanently (owner only, for mistakes)
        if (btn.classList.contains('delete-link')) {
          if (!confirm(`Delete your set "${setName}"? This removes the set file for everyone. This cannot be undone.`)) return;
          const r = await api.fetch(`/api/delete_set/${encodeURIComponent(setName)}`, { method: 'POST' });
          if (!r.ok) throw new Error('delete failed');
          myMap.delete(setName);
          myList = Array.from(myMap.values());
          globalMap.delete(setName);
          globalList = globalList.filter(s => s.name !== setName);
          rebuildMaps();
          renderTable();
          els.status.textContent = `Deleted "${setName}".`;
          return;
        }
      } catch (e) {
        console.error(e);
        els.status.textContent = 'Action failed.';
      }
    });

    // --- Sorting (click headers) ---
    document.querySelectorAll('th.sortable').forEach(th => {
      th.addEventListener('click', () => {
        const key = th.dataset.key;
        if (sortKey === key) { sortDir = -sortDir; } else { sortKey = key; sortDir = 1; }
        localStorage.setItem('lp.manage.sortKey', sortKey);
        localStorage.setItem('lp.manage.sortDir', String(sortDir));
        renderTable();
      });
    });

    // --- Tabs ---
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => setActiveTab(btn.dataset.tab));
    });

    // --- Search (debounced) ---
    els.search.addEventListener('input', (function debounce(fn, ms){ let t; return e=>{clearTimeout(t); t=setTimeout(fn,ms)}; })(() => {
      localStorage.setItem('lp.manage.q', els.search.value);
      renderTable();
    }, 200));

    // --- Init ---
    (async function init() {
      setActiveTab(activeTab);
      await loadSets();
    })();
  </script>
</body>
</html>
