<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Path to POLISH â€¢ Groups</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --brand:#2d6cdf; --bg:#f7f7fb; --card:#ffffff; --text:#0c0f14; --muted:#5a6472; --border:#e6e6ef;
      --shadow:0 8px 24px rgba(0,0,0,.08); --radius:14px; --pad:16px;
      --focus:0 0 0 3px rgba(45,108,223,.35);
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0b0c10; --card:#121418; --text:#e7e9ee; --muted:#a7b0bf; --border:#1e2230; --shadow:0 6px 22px rgba(0,0,0,.35); }
    }
    *{ box-sizing:border-box }
    body{ font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Ubuntu,Helvetica,Arial; background:var(--bg); color:var(--text); margin:0; padding-bottom:92px; }

    /* Top bar */
    header{ position:sticky; top:0; z-index:10; background:var(--card); border-bottom:1px solid var(--border); }
    header .bar{ display:flex; justify-content:space-between; align-items:center; gap:12px; padding:12px 16px; }
    .hello{ font-size:clamp(18px,4.2vw,22px); margin:0 }
    .head-actions a, .head-actions button{
      margin-left:8px; font-size:14px; color:var(--brand);
      background:none; border:1px solid var(--border); padding:8px 10px; border-radius:10px; text-decoration:none; cursor:pointer
    }
    .head-actions button{ color:var(--text); }
    .head-actions .btn-primary{ background:var(--brand); color:#fff; border-color:transparent }

    /* Layout: single column */
    main{ width:100%; max-width:900px; margin:16px auto 90px; padding:0 16px; display:grid; gap:16px; grid-template-columns:1fr; }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:var(--pad); box-shadow:var(--shadow) }
    h2{ margin:0 0 8px; font-size:clamp(20px,4.8vw,26px) }
    .muted{ color:var(--muted) }
    .tiny{ font-size:12px; color:var(--muted) }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }

    .btn{ display:inline-flex; align-items:center; justify-content:center; height:36px; padding:0 12px; border-radius:10px; border:1px solid var(--border); background:var(--card); color:var(--text); text-decoration:none; cursor:pointer }
    .btn:focus{ outline:none; box-shadow:var(--focus) }
    .btn-primary{ background:var(--brand); color:#fff; border-color:transparent }

    .table-wrap{ overflow:auto; border:1px solid var(--border); border-radius:12px }
    table{ width:100%; border-collapse:collapse }
    th, td{ text-align:left; padding:10px 8px; border-bottom:1px solid var(--border); font-size:14px }

    nav.bottom{ position:fixed; left:0; right:0; bottom:0; background:var(--card); border-top:1px solid var(--border); display:flex; justify-content:space-around; padding:6px 8px; gap:8px; }
    nav.bottom a{ flex:1; text-align:center; padding:8px; text-decoration:none; color:var(--text); border-radius:10px; display:flex; flex-direction:column; align-items:center; gap:4px; font-size:12px }
    nav.bottom a svg{ width:20px; height:20px }
    nav.bottom a.active{ background:rgba(45,108,223,.12); color:var(--brand) }
    @supports(padding: max(0px)){ nav.bottom{ padding-bottom: max(6px, env(safe-area-inset-bottom)) } }

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.35);
      display:none; align-items:center; justify-content:center; z-index:50;
    }
    .modal{ width:min(520px, 92vw); background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:16px; }
    .modal h3{ margin:0 0 10px; font-size:18px }
    .modal .tabs{ display:flex; gap:8px; margin-bottom:10px }
    .modal .tabs button{ flex:1; height:36px }
    .modal .field{ display:flex; gap:8px; margin:8px 0 14px }
    .modal input{
      flex:1; min-width:140px; padding:10px; border:1px solid var(--border);
      border-radius:10px; background:var(--card); color:var(--text);
    }
    .modal .actions{ display:flex; gap:8px; justify-content:flex-end }
    .modal .hint{ font-size:12px; color:var(--muted) }
    .show{ display:flex !important; }
  </style>
</head>
<body>
  <!-- Top bar -->
  <header>
    <div class="bar">
      <h1 class="hello">Groups</h1>
      <div class="head-actions">
        <!-- Single dynamic action -->
        <button id="btnGroupAction" type="button" class="btn-primary">Join or Create</button>

        <a href="./profile.html" id="profileBtn">Profile</a>
        <a href="./login.html" id="loginLink">Sign In</a>
        <a href="./register.html" id="registerLink">Register</a>
        <button id="logoutBtn" style="display:none;">Logout</button>
      </div>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="row" style="justify-content:space-between; align-items:flex-end">
        <div>
          <h2 id="groupNameHdr" style="margin:0">No group yet</h2>
          <div class="muted tiny" id="groupMeta">Create or join to get started.</div>
          <div class="muted tiny" id="multiNote" style="display:none">Multiple groups found; showing the first.</div>
        </div>
        <div class="row">
          <button id="inviteBtn" class="btn" type="button" style="display:none">Invite members</button>
          <button id="copyLinkBtn" class="btn" type="button" style="display:none">Copy invite link</button>
        </div>
      </div>

      <div class="row" style="margin:12px 0; gap:12px; flex-wrap:wrap">
        <button id="tabActivity" class="btn btn-primary" type="button">Recent activity</button>
        <button id="tabLeaderboard" class="btn" type="button">Weekly leaderboard</button>
      </div>

      <div id="panelActivity">
        <div class="table-wrap">
          <table id="activityTable" style="display:none;">
            <thead>
              <tr>
                <th>When</th>
                <th>Person</th>
                <th>Collection</th>
                <th>Activity</th>
                <th>Score</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="emptyActivity" class="muted" style="padding:10px">No recent activity.</div>
      </div>

      <div id="panelLeaderboard" style="display:none">
        <div class="table-wrap">
          <table id="lbTable" style="display:none;">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Member</th>
                <th>Gold (week)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="emptyLb" class="muted" style="padding:10px">No data for this week.</div>
      </div>
    </section>
  </main>

  <!-- Modal: Create / Join -->
  <div id="groupModal" class="modal-backdrop" aria-modal="true" role="dialog">
    <div class="modal">
      <h3 id="modalTitle">Create or join a group</h3>
      <div class="tabs">
        <button id="tabCreate" class="btn btn-primary" type="button">Create</button>
        <button id="tabJoin" class="btn" type="button">Join</button>
      </div>

      <!-- Create form -->
      <div id="viewCreate">
        <div class="field">
          <input id="inpGroupName" placeholder="New group name" />
          <button id="btnCreate" class="btn btn-primary" type="button">Create</button>
        </div>
        <div class="hint">Create a team name and invite friends with a link.</div>
      </div>

      <!-- Join form -->
      <div id="viewJoin" style="display:none">
        <div class="field">
          <input id="inpJoinCode" placeholder="Enter invite code" />
          <button id="btnJoin" class="btn" type="button">Join</button>
        </div>
        <div class="hint">Paste the invite code or open the link you received.</div>
      </div>

      <div class="actions">
        <button id="btnClose" class="btn" type="button">Close</button>
      </div>
    </div>
  </div>

  <!-- Bottom nav -->
  <nav class="bottom">
    <a href="./index.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 10.5L12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1v-10.5Z" stroke-width="1.5"/></svg>
      <span>Home</span>
    </a>
    <a href="./learn.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 6h16M4 12h16M4 18h9" stroke-width="1.5" stroke-linecap="round"/></svg>
      <span>Learn</span>
    </a>
    <a href="./manage_sets/">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="4" width="18" height="16" rx="2" ry="2" stroke-width="1.5"/><path d="M7 8h10M7 12h10M7 16h7" stroke-width="1.5" stroke-linecap="round"/></svg>
      <span>Library</span>
    </a>
    <a href="./dashboard.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 14h6V4H4v10Zm10 6h6V4h-6v16Z" stroke-width="1.5"/></svg>
      <span>Dashboard</span>
    </a>
    <a href="./groups.html" class="active" aria-current="page">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <circle cx="8" cy="8" r="3" stroke-width="1.5"/>
        <path d="M2 20v-1c0-3 3-5 6-5" stroke-width="1.5" stroke-linecap="round"/>
        <circle cx="16" cy="10" r="3" stroke-width="1.5"/>
        <path d="M11 20v-1c0-2.5 2.5-4.5 5-5" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
      <span>Groups</span>
    </a>
  </nav>

  <script src="./static/js/api.js"></script>
  <script>
    // Top bar auth wiring
    (async () => {
      const logoutBtn = document.getElementById('logoutBtn');
      const loginLink = document.getElementById('loginLink');
      const registerLink = document.getElementById('registerLink');
      try {
        const r = await api.fetch('/api/me');
        if (r.ok) { loginLink.style.display='none'; registerLink.style.display='none'; logoutBtn.style.display='inline-block'; }
      } catch(_) {}
      logoutBtn?.addEventListener('click', async (e)=>{ e.preventDefault(); try{ await api.fetch('/api/logout',{method:'POST'});}catch(_){}
        localStorage.removeItem('lp_token'); location.href='./login.html'; });
    })();
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const $ = (id)=> document.getElementById(id);

      // Helpers
      function shortDate(iso){ if(!iso) return ''; const d=new Date(iso); return d.toLocaleString(); }
      function modeLabel(m){ m=(m||'').toLowerCase(); if(m==='practice'||m==='speak') return 'Speak'; if(m==='reading'||m==='read') return 'Read'; if(m==='listening'||m==='listen') return 'Listen'; return 'Learn'; }
      async function copyTextToClipboard(text){
        try{
          await navigator.clipboard.writeText(text);
          return true;
        }catch(_){
          try{
            const ta=document.createElement('textarea');
            ta.value=text; ta.setAttribute('readonly','');
            ta.style.position='fixed'; ta.style.opacity='0'; ta.style.left='-9999px';
            document.body.appendChild(ta);
            ta.select(); ta.setSelectionRange(0, ta.value.length);
            const ok=document.execCommand('copy');
            document.body.removeChild(ta);
            return ok;
          }catch(__){ return false; }
        }
      }
      function joinUrlFromCode(code){
        const base = new URL('./groups.html', window.location.href);
        base.search = '?code=' + encodeURIComponent(code);
        return base.toString();
      }

      const dom = {
        name: $('groupNameHdr'),
        meta: $('groupMeta'),
        multiNote: $('multiNote'),

        tabA: $('tabActivity'),
        tabL: $('tabLeaderboard'),
        panA: $('panelActivity'),
        panL: $('panelLeaderboard'),

        actTable: $('activityTable'),
        actBody: document.querySelector('#activityTable tbody'),
        actEmpty: $('emptyActivity'),

        lbTable: $('lbTable'),
        lbBody: document.querySelector('#lbTable tbody'),
        lbEmpty: $('emptyLb'),

        // Single action
        btnAction: $('btnGroupAction'),

        // Share/copy
        invite: $('inviteBtn'),
        copy: $('copyLinkBtn'),

        // Modal
        modal: $('groupModal'),
        tabCreate: $('tabCreate'),
        tabJoin: $('tabJoin'),
        viewCreate: $('viewCreate'),
        viewJoin: $('viewJoin'),
        btnCreate: $('btnCreate'),
        btnJoin: $('btnJoin'),
        inpGroupName: $('inpGroupName'),
        inpJoinCode: $('inpJoinCode'),
        btnClose: $('btnClose'),
        modalTitle: $('modalTitle'),
      };

      let groups = [];
      let current = null;

      function openModal(which='create'){
        dom.modal?.classList.add('show');
        if(which==='join') showJoinTab(); else showCreateTab();
        setTimeout(()=> (which==='join'? dom.inpJoinCode: dom.inpGroupName)?.focus(), 0);
      }
      function closeModal(){ dom.modal?.classList.remove('show'); }
      function showCreateTab(){
        dom.tabCreate?.classList.add('btn-primary'); dom.tabJoin?.classList.remove('btn-primary');
        dom.viewCreate.style.display='block'; dom.viewJoin.style.display='none';
        dom.modalTitle.textContent='Create a group';
      }
      function showJoinTab(){
        dom.tabJoin?.classList.add('btn-primary'); dom.tabCreate?.classList.remove('btn-primary');
        dom.viewJoin.style.display='block'; dom.viewCreate.style.display='none';
        dom.modalTitle.textContent='Join a group';
      }

      function setCurrent(g){
        current = g || null;
        if(!current){
          dom.name.textContent = 'No group yet';
          dom.meta.textContent = 'Create or join to get started.';
          dom.invite.style.display = 'none';
          dom.copy.style.display = 'none';
          dom.btnAction.textContent = 'Join or Create';
          dom.btnAction.classList.add('btn-primary');
          dom.btnAction.onclick = (e)=>{ e.preventDefault(); openModal('create'); };
          return;
        }
        dom.name.textContent = current.group_name || ('Group ' + current.group_id);
        dom.meta.textContent = `Role: ${current.role || 'member'}`;
        dom.invite.style.display = 'inline-flex';
        dom.copy.style.display = 'inline-flex';
        dom.btnAction.textContent = 'Leave group';
        dom.btnAction.classList.remove('btn-primary');
        dom.btnAction.onclick = async (e)=>{
          e.preventDefault();
          if(!confirm('Are you sure you want to leave your group?')) return;
          try{
            const r = await api.fetch(`/api/groups/${current.group_id}/leave`, { method:'DELETE' });
            if(r.ok){ await loadGroups(); }
            else alert('Failed to leave group');
          }catch(_){ alert('Failed to leave group'); }
        };
      }

      async function loadGroups(){
        try{
          const r = await api.fetch('/api/my/groups');
          groups = r.ok ? await r.json() : [];
        }catch(_){ groups = []; }

        if(groups.length > 1){
          dom.multiNote.style.display = 'block';
        }else{
          dom.multiNote.style.display = 'none';
        }

        const group = groups[0] || null;
        setCurrent(group);

        if(!group){
          // Auto-open modal to speed up onboarding
          openModal('create');
        }else{
          await showActivity();
        }
      }

      async function showActivity(){
        if(!current) return;
        dom.tabA?.classList.add('btn-primary'); dom.tabL?.classList.remove('btn-primary');
        dom.panA.style.display='block'; dom.panL.style.display='none';
        dom.actTable.style.display='none'; dom.actEmpty.style.display='block'; dom.actBody.innerHTML='';
        try{
          let r = await api.fetch(`/api/groups/${current.group_id}/recent_activity?limit=50`);
          if(!r.ok) r = await api.fetch('/api/my/groups/recent?limit=50');
          if(r.ok){
            const acts = await r.json();
            if(Array.isArray(acts) && acts.length){
              dom.actEmpty.style.display='none'; dom.actTable.style.display='table';
              dom.actBody.innerHTML = acts.map(a=>`
                <tr>
                  <td>${shortDate(a.timestamp || a.when)}</td>
                  <td>${a.user_name || a.user || 'â€”'}</td>
                  <td>${a.set_name || 'â€”'}</td>
                  <td>${modeLabel(a.mode || a.activity || '')}</td>
                  <td>${(a.score ?? 'â€”')}</td>
                </tr>
              `).join('');
            }
          }
        }catch(_){}
      }

      async function showLeaderboard(){
        if(!current) return;
        dom.tabL?.classList.add('btn-primary'); dom.tabA?.classList.remove('btn-primary');
        dom.panL.style.display='block'; dom.panA.style.display='none';
        dom.lbTable.style.display='none'; dom.lbEmpty.style.display='block'; dom.lbBody.innerHTML='';
        try{
          const r = await api.fetch(`/api/groups/${current.group_id}/leaderboard?window=week`);
          if(r.ok){
            const data = await r.json();
            const rows = data.leaderboard || data || [];
            if(Array.isArray(rows) && rows.length){
              dom.lbEmpty.style.display='none'; dom.lbTable.style.display='table';
              dom.lbBody.innerHTML = rows.map((x,i)=>`
                <tr>
                  <td>${i+1}</td>
                  <td>${x.name || x.user_name || 'â€”'}</td>
                  <td>${x.points ?? x.gold ?? 0}</td>
                </tr>
              `).join('');
            }
          }
        }catch(_){}
      }

      // Tabs on main panel
      dom.tabActivity?.addEventListener('click', (e)=>{ e.preventDefault(); showActivity(); });
      dom.tabLeaderboard?.addEventListener('click', (e)=>{ e.preventDefault(); showLeaderboard(); });

      // Modal controls
      dom.tabCreate?.addEventListener('click', (e)=>{ e.preventDefault(); showCreateTab(); });
      dom.tabJoin?.addEventListener('click', (e)=>{ e.preventDefault(); showJoinTab(); });
      dom.btnClose?.addEventListener('click', (e)=>{ e.preventDefault(); closeModal(); });
      dom.modal?.addEventListener('click', (e)=>{ if (e.target === dom.modal) closeModal(); });

      // Create / Join actions
      dom.btnCreate?.addEventListener('click', async (e)=>{
        e.preventDefault();
        const name = (dom.inpGroupName?.value || '').trim();
        if(!name) return;
        try{
          const r = await api.fetch('/api/groups', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ name }) });
          if(r.ok){ dom.inpGroupName.value=''; closeModal(); await loadGroups(); alert('Group created'); }
          else { let j={}; try{ j=await r.json(); }catch(_){}
            alert('Failed to create group: ' + (j.error || r.status)); }
        }catch(_){ alert('Failed to create group'); }
      });
      dom.inpGroupName?.addEventListener('keydown', (e)=>{ if(e.key==='Enter') dom.btnCreate?.click(); });

      dom.btnJoin?.addEventListener('click', async (e)=>{
        e.preventDefault();
        const code = (dom.inpJoinCode?.value || '').trim();
        if(!code) return;
        try{
          const r = await api.fetch('/api/groups/join', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ code }) });
          if(r.ok){ dom.inpJoinCode.value=''; closeModal(); await loadGroups(); alert('Joined!'); }
          else { let j={}; try{ j=await r.json(); }catch(_){}
            alert('Failed to join group: ' + (j.error || r.status)); }
        }catch(_){ alert('Failed to join group'); }
      });
      dom.inpJoinCode?.addEventListener('keydown', (e)=>{ if(e.key==='Enter') dom.btnJoin?.click(); });

      // Invite / Copy link (no prompts, no odd context menu)
      dom.invite?.addEventListener('click', async (e)=>{
        e.preventDefault(); e.stopPropagation();
        if(!current) return;
        let code='';
        try{
          const r = await api.fetch(`/api/groups/${current.group_id}/invite_code`);
          const j = r.ok ? await r.json() : {};
          code = j.code || j.invite_code || '';
        }catch(_){}
        if(!code){ alert('No invite code available'); return; }

        const url = joinUrlFromCode(code);
        const text = `Join ${current.group_name || 'our group'} on Path to POLISH.`;
        if (navigator.share){
          try { await navigator.share({ title:'Join my group', text, url }); return; } catch(_){}
        }
        const ok = await copyTextToClipboard(url);
        alert(ok ? 'Invite link copied' : url);
      });
      dom.invite?.addEventListener('contextmenu', (e)=> e.preventDefault());

      dom.copy?.addEventListener('click', async (e)=>{
        e.preventDefault(); e.stopPropagation();
        if(!current) return;
        try{
          let code=''; let r = await api.fetch(`/api/groups/${current.group_id}/invite_code`);
          if(r.ok){ const j = await r.json(); code = j.code || j.invite_code || ''; }
          if(!code) { alert('No invite code available'); return; }
          const url = joinUrlFromCode(code);
          const ok = await copyTextToClipboard(url);
          dom.copy.textContent = ok ? 'Link copied!' : 'Copy invite link';
          if(!ok) alert(url);
          setTimeout(()=> dom.copy.textContent = 'Copy invite link', 1200);
        }catch(_){ alert('Failed to copy'); }
      });
      dom.copy?.addEventListener('contextmenu', (e)=> e.preventDefault());

      // Auto-join from ?code=â€¦
      async function autoJoinFromQuery(){
        const params = new URLSearchParams(location.search);
        const code = (params.get('code') || '').trim();
        if (!code) return false;
        try {
          const r = await api.fetch('/api/groups/join', { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ code }) });
          if (r.ok) {
            alert('Joined the group!');
            params.delete('code');
            const q = params.toString();
            history.replaceState({}, '', location.pathname + (q ? `?${q}` : ''));
            return true;
          } else {
            let j = {}; try { j = await r.json(); } catch(_){}
            showJoinTab(); openModal('join');
            dom.inpJoinCode && (dom.inpJoinCode.value = code);
            alert('Could not join: ' + (j.error || r.status));
          }
        } catch(_){}
        return false;
      }

      (async function boot(){
        await autoJoinFromQuery();
        await loadGroups();
      })();
    });
  </script>
</body>
</html>
