<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Path to POLISH • Groups</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --brand:#2d6cdf; --bg:#f7f7fb; --card:#ffffff; --text:#0c0f14; --muted:#5a6472; --border:#e6e6ef;
      --shadow:0 8px 24px rgba(0,0,0,.08); --radius:14px; --pad:16px;
      --focus:0 0 0 3px rgba(45,108,223,.35);
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0b0c10; --card:#121418; --text:#e7e9ee; --muted:#a7b0bf; --border:#1e2230; --shadow:0 6px 22px rgba(0,0,0,.35); }
    }
    *{ box-sizing:border-box }
    body{ font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Ubuntu,Helvetica,Arial; background:var(--bg); color:var(--text); margin:0; padding-bottom:92px; }

    /* Top bar */
    header{ position:sticky; top:0; z-index:10; background:var(--card); border-bottom:1px solid var(--border); }
    header .bar{ display:flex; justify-content:space-between; align-items:center; gap:12px; padding:12px 16px; }
    .hello{ font-size:clamp(18px,4.2vw,22px); margin:0 }
    .head-actions a, .head-actions button{ margin-left:8px; font-size:14px; color:var(--brand); background:none; border:1px solid var(--border); padding:8px 10px; border-radius:10px; text-decoration:none; cursor:pointer; }
    .head-actions button{ color:var(--text); }

    /* Layout */
    main{ width:100%; max-width:1100px; margin:16px auto 90px; padding:0 16px; display:grid; gap:16px; grid-template-columns:1fr; }
    @media (min-width:960px){ main{ grid-template-columns:320px 1fr; } }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); padding:var(--pad); box-shadow:var(--shadow) }
    h2{ margin:0 0 8px; font-size:clamp(20px,4.8vw,26px) }
    .muted{ color:var(--muted) }
    .tiny{ font-size:12px; color:var(--muted) }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }

    .list{ display:grid; gap:8px; margin-top:8px }
    .gitem{ display:flex; justify-content:space-between; align-items:center; gap:10px; padding:10px; border:1px solid var(--border); border-radius:10px; background:var(--card); cursor:pointer }
    .gitem.active{ outline:2px solid rgba(45,108,223,.25) }
    .pill{ display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid var(--border); color:var(--muted); font-size:12px }

    .btn{ display:inline-flex; align-items:center; justify-content:center; height:36px; padding:0 12px; border-radius:10px; border:1px solid var(--border); background:var(--card); color:var(--text); text-decoration:none; cursor:pointer }
    .btn:focus{ outline:none; box-shadow:var(--focus) }
    .btn[disabled]{ opacity:.6; cursor:not-allowed }
    .btn-primary{ background:var(--brand); color:#fff; border-color:transparent }

    .table-wrap{ overflow:auto; border:1px solid var(--border); border-radius:12px }
    table{ width:100%; border-collapse:collapse }
    th, td{ text-align:left; padding:10px 8px; border-bottom:1px solid var(--border); font-size:14px }

    /* Bottom nav */
    nav.bottom{ position:fixed; left:0; right:0; bottom:0; background:var(--card); border-top:1px solid var(--border); display:flex; justify-content:space-around; padding:6px 8px; gap:8px; }
    nav.bottom a{ flex:1; text-align:center; padding:8px; text-decoration:none; color:var(--text); border-radius:10px; display:flex; flex-direction:column; align-items:center; gap:4px; font-size:12px }
    nav.bottom a svg{ width:20px; height:20px }
    nav.bottom a.active{ background:rgba(45,108,223,.12); color:var(--brand) }
    @supports(padding: max(0px)){ nav.bottom{ padding-bottom: max(6px, env(safe-area-inset-bottom)) } }
  </style>
</head>
<body>
  <!-- Top bar -->
  <header>
    <div class="bar">
      <h1 class="hello">Groups</h1>
      <div class="head-actions">
        <a href="./profile.html" id="profileBtn">Profile</a>
        <a href="./login.html" id="loginLink">Sign In</a>
        <a href="./register.html" id="registerLink">Register</a>
        <button id="logoutBtn" style="display:none;">Logout</button>
      </div>
    </div>
  </header>

  <main>
    <aside class="card">
      <h2>Groups</h2>

      <!-- Create / Join -->
      <div class="row" style="margin:6px 0 12px">
        <input id="groupName" placeholder="New group name" style="flex:1; min-width:140px; padding:8px; border:1px solid var(--border); border-radius:10px; background:var(--card); color:var(--text);" />
        <button id="createGroupBtn" class="btn btn-primary">Create</button>
      </div>
      <div class="row" style="margin:-6px 0 12px">
        <input id="joinCode" placeholder="Join code" style="flex:1; min-width:140px; padding:8px; border:1px solid var(--border); border-radius:10px; background:var(--card); color:var(--text);" />
        <button id="joinGroupBtn" class="btn">Join</button>
      </div>

      <h4 style="margin:8px 0">My groups</h4>
      <div id="groupList" class="list"></div>
      <div id="noGroups" class="muted" style="display:none;">You’re not in any groups yet.</div>
    </aside>

    <section class="card">
      <div class="row" style="justify-content:space-between; align-items:flex-end">
        <div>
          <h2 id="groupNameHdr" style="margin:0">Join a group, or start your own</h2>
          <div class="muted tiny" id="groupMeta"></div>
        </div>
        <div class="row">
          <button id="inviteBtn" class="btn" style="display:none">Invite members</button>
          <button id="copyCodeBtn" class="btn" style="display:none">Copy invite code</button>
          <button id="leaveBtn" class="btn" style="display:none">Leave group</button>
        </div>
      </div>

      <div class="row" style="margin:12px 0; gap:12px; flex-wrap:wrap">
        <button id="tabActivity" class="btn btn-primary">Recent activity</button>
        <button id="tabLeaderboard" class="btn">Weekly leaderboard</button>
      </div>

      <div id="panelActivity">
        <div class="table-wrap">
          <table id="activityTable" style="display:none;">
            <thead>
              <tr>
                <th>When</th>
                <th>Person</th>
                <th>Collection</th>
                <th>Activity</th>
                <th>Score</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="emptyActivity" class="muted" style="padding:10px">No recent activity.</div>
      </div>

      <div id="panelLeaderboard" style="display:none">
        <div class="table-wrap">
          <table id="lbTable" style="display:none;">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Member</th>
                <th>Gold (week)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div id="emptyLb" class="muted" style="padding:10px">No data for this week.</div>
      </div>
    </section>
  </main>

  <!-- Bottom nav -->
  <nav class="bottom">
    <a href="./index.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 10.5L12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1v-10.5Z" stroke-width="1.5"/></svg>
      <span>Home</span>
    </a>
    <a href="./learn.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 6h16M4 12h16M4 18h9" stroke-width="1.5" stroke-linecap="round"/></svg>
      <span>Learn</span>
    </a>
    <a href="./manage_sets/">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="4" width="18" height="16" rx="2" ry="2" stroke-width="1.5"/><path d="M7 8h10M7 12h10M7 16h7" stroke-width="1.5" stroke-linecap="round"/></svg>
      <span>Library</span>
    </a>
    <a href="./dashboard.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 14h6V4H4v10Zm10 6h6V4h-6v16Z" stroke-width="1.5"/></svg>
      <span>Dashboard</span>
    </a>
    <a href="./groups.html" class="active" aria-current="page">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <circle cx="8" cy="8" r="3" stroke-width="1.5"/>
        <path d="M2 20v-1c0-3 3-5 6-5" stroke-width="1.5" stroke-linecap="round"/>
        <circle cx="16" cy="10" r="3" stroke-width="1.5"/>
        <path d="M11 20v-1c0-2.5 2.5-4.5 5-5" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
      <span>Groups</span>
    </a>
  </nav>

  <script src="./static/js/api.js"></script>
  <script>
    // Top bar auth wiring
    (async () => {
      const logoutBtn = document.getElementById('logoutBtn');
      const loginLink = document.getElementById('loginLink');
      const registerLink = document.getElementById('registerLink');
      try {
        const r = await api.fetch('/api/me');
        if (r.ok) { loginLink.style.display='none'; registerLink.style.display='none'; logoutBtn.style.display='inline-block'; }
      } catch(_) {}
      logoutBtn?.addEventListener('click', async ()=>{ try{ await api.fetch('/api/logout',{method:'POST'});}catch(_){}
        localStorage.removeItem('lp_token'); location.href='./login.html'; });
    })();
  </script>

  <script>
    function shortDate(iso){ if(!iso) return ''; const d=new Date(iso); return d.toLocaleString(); }
    function modeLabel(m){
      m=(m||'').toLowerCase();
      if(m==='practice'||m==='speak') return 'Speak';
      if(m==='reading'||m==='read') return 'Read';
      if(m==='listening'||m==='listen') return 'Listen';
      return 'Learn';
    }

    const dom = {
      list: document.getElementById('groupList'),
      none: document.getElementById('noGroups'),
      name: document.getElementById('groupNameHdr'),
      meta: document.getElementById('groupMeta'),
      copy: document.getElementById('copyCodeBtn'),
      leave: document.getElementById('leaveBtn'),
      invite: document.getElementById('inviteBtn'),

      tabA: document.getElementById('tabActivity'),
      tabL: document.getElementById('tabLeaderboard'),
      panA: document.getElementById('panelActivity'),
      panL: document.getElementById('panelLeaderboard'),

      actTable: document.getElementById('activityTable'),
      actBody: document.querySelector('#activityTable tbody'),
      actEmpty: document.getElementById('emptyActivity'),

      lbTable: document.getElementById('lbTable'),
      lbBody: document.querySelector('#lbTable tbody'),
      lbEmpty: document.getElementById('emptyLb'),

      createBtn: document.getElementById('createGroupBtn'),
      joinBtn: document.getElementById('joinGroupBtn'),
      nameInput: document.getElementById('groupName'),
      codeInput: document.getElementById('joinCode'),
    };

    let groups = [];
    let current = null;

    async function loadGroups(){
      dom.list.innerHTML = '';
      dom.none.style.display = 'none';
      try{
        const r = await api.fetch('/api/my/groups');
        groups = r.ok ? await r.json() : [];
      }catch(_){ groups = []; }

      if(!groups.length){
        dom.none.style.display = 'block';
        setCurrent(null, { zero:true });
        return;
      }
      groups.forEach((g,idx)=>{
        const row = document.createElement('div');
        row.className = 'gitem' + (idx===0 ? ' active' : '');
        row.dataset.id = g.group_id;
        row.innerHTML = `<div><b>${g.group_name || ('Group '+g.group_id)}</b><div class="pill">${g.role || 'member'}</div></div><div>→</div>`;
        row.onclick = ()=> selectGroup(g, row);
        dom.list.appendChild(row);
      });
      // Auto-select first group so “Select a group” only appears if you have 2+ and deselect manually (we never do).
      selectGroup(groups[0], dom.list.firstElementChild);
    }

    function setCurrent(g, { zero=false } = {}){
      current = g;
      if (g) {
        dom.name.textContent = g.group_name || ('Group '+g.group_id);
        dom.meta.textContent = `Role: ${g.role || 'member'}`;
      } else {
        dom.name.textContent = zero ? 'Join a group, or start your own' : 'Select a group';
        dom.meta.textContent = '';
      }
      const show = !!g;
      dom.copy.style.display   = show ? 'inline-flex' : 'none';
      dom.leave.style.display  = show ? 'inline-flex' : 'none';
      dom.invite.style.display = show ? 'inline-flex' : 'none';
    }

    dom.invite.addEventListener('click', async ()=>{
      if(!current) return;
      dom.invite.disabled = true;
      let code = '';
      try {
        const r = await api.fetch(`/api/groups/${current.group_id}/invite_code`);
        const j = r.ok ? await r.json() : {};
        code = j.code || j.invite_code || '';
      } catch(_){}
      if(!code){ alert('No invite code available'); dom.invite.disabled=false; return; }

      const joinUrl = new URL(`./groups.html?code=${encodeURIComponent(code)}`, window.location.href).toString();
      const emails = prompt('Invite by email (comma-separated), or leave blank to copy/share the link:', '');
      const subject = 'Join my Path to POLISH group';
      const groupName = (current.group_name || 'our group');
      const body = `Hi!\n\nJoin ${groupName} in Path to POLISH.\n\nClick: ${joinUrl}\n\nOr open the app and use code: ${code}\n`;

      if (!emails && navigator.share) {
        try { await navigator.share({ title: subject, text: body, url: joinUrl }); dom.invite.disabled=false; return; } catch(_){}
      }
      if (emails) {
        const mailto = `mailto:${encodeURIComponent(emails)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        window.location.href = mailto;
      } else {
        try { await navigator.clipboard.writeText(joinUrl); alert('Invite link copied'); }
        catch(_){ alert(joinUrl); }
      }
      dom.invite.disabled = false;
    });

    async function selectGroup(g, rowEl){
      if (!g || !rowEl) { setCurrent(null); return; }
      [...dom.list.children].forEach(n=> n.classList.remove('active'));
      rowEl.classList.add('active');
      setCurrent(g);
      await showActivity();
    }

    async function showActivity(){
      if(!current){ return; }
      dom.tabA.classList.add('btn-primary'); dom.tabL.classList.remove('btn-primary');
      dom.panA.style.display = 'block'; dom.panL.style.display = 'none';

      dom.actTable.style.display = 'none';
      dom.actEmpty.style.display = 'block';
      dom.actBody.innerHTML = '';
      try{
        let r = await api.fetch(`/api/groups/${current.group_id}/recent_activity?limit=50`);
        if(!r.ok) r = await api.fetch('/api/my/groups/recent?limit=50');
        if(r.ok){
          const acts = await r.json();
          if(Array.isArray(acts) && acts.length){
            dom.actEmpty.style.display='none';
            dom.actTable.style.display='table';
            dom.actBody.innerHTML = acts.map(a=>`
              <tr>
                <td>${shortDate(a.timestamp || a.when)}</td>
                <td>${a.user_name || a.user || '—'}</td>
                <td>${a.set_name || '—'}</td>
                <td>${modeLabel(a.mode || a.activity || '')}</td>
                <td>${(a.score ?? '—')}</td>
              </tr>
            `).join('');
          }
        }
      }catch(_){}
    }

    async function showLeaderboard(){
      if(!current){ return; }
      dom.tabL.classList.add('btn-primary'); dom.tabA.classList.remove('btn-primary');
      dom.panL.style.display = 'block'; dom.panA.style.display = 'none';

      dom.lbTable.style.display = 'none';
      dom.lbEmpty.style.display = 'block';
      dom.lbBody.innerHTML = '';
      try{
        const r = await api.fetch(`/api/groups/${current.group_id}/leaderboard?window=week`);
        if(r.ok){
          const data = await r.json();
          const rows = data.leaderboard || data || [];
          if(Array.isArray(rows) && rows.length){
            dom.lbEmpty.style.display='none';
            dom.lbTable.style.display='table';
            dom.lbBody.innerHTML = rows.map((x,i)=>`
              <tr>
                <td>${i+1}</td>
                <td>${x.name || x.user_name || '—'}</td>
                <td>${x.points ?? x.gold ?? 0}</td>
              </tr>
            `).join('');
          }
        }
      }catch(_){}
    }

    dom.tabActivity.addEventListener('click', showActivity);
    dom.tabLeaderboard.addEventListener('click', showLeaderboard);

    dom.createBtn.addEventListener('click', async ()=>{
      const name = (dom.nameInput.value || '').trim();
      if(!name){ alert('Please enter a group name'); return; }
      dom.createBtn.disabled = true;
      try{
        const r = await api.fetch('/api/groups', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ name })
        });
        if(r.ok){
          dom.nameInput.value='';
          await loadGroups();
          alert('Group created');
        } else {
          let msg = 'Failed to create group';
          try {
            const j = await r.json();
            if (r.status === 401) msg = 'Please sign in to create a group.';
            else if (j.error === 'name_required') msg = 'Please enter a group name.';
            else if (j.message) msg = j.message;
          } catch(_) {}
          alert(msg);
        }
      }catch(_){ alert('Network error creating group'); }
      dom.createBtn.disabled = false;
    });

    dom.joinBtn.addEventListener('click', async ()=>{
      const code = (dom.codeInput.value || '').trim();
      if(!code){ alert('Enter a join code.'); return; }
      dom.joinBtn.disabled = true;
      try{
        const r = await api.fetch('/api/groups/join', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({ code })
        });
        if(r.ok){
          dom.codeInput.value='';
          await loadGroups();
          alert('Joined!');
        } else {
          let msg = 'Failed to join group';
          try {
            const j = await r.json();
            if (r.status === 401) msg = 'Please sign in to join a group.';
            else if (j.error === 'invalid_code') msg = 'That code was not found.';
            else if (j.error) msg = j.error;
            else if (j.message) msg = j.message;
          } catch(_) {}
          alert(msg);
        }
      }catch(_){ alert('Network error joining group'); }
      dom.joinBtn.disabled = false;
    });

    dom.copy.addEventListener('click', async ()=>{
      if(!current) return;
      dom.copy.disabled = true;
      try{
        let code=''; let r = await api.fetch(`/api/groups/${current.group_id}/invite_code`);
        if(r.ok){ const j = await r.json(); code = j.code || j.invite_code || ''; }
        if(!code) { alert('No invite code available'); dom.copy.disabled=false; return; }
        await navigator.clipboard.writeText(String(code));
        dom.copy.textContent = 'Copied!';
        setTimeout(()=> dom.copy.textContent = 'Copy invite code', 1200);
      }catch(_){ alert('Failed to copy'); }
      dom.copy.disabled = false;
    });

    dom.leave.addEventListener('click', async ()=>{
      if(!current) return;
      if(!confirm('Leave this group?')) return;
      dom.leave.disabled = true;
      try{
        const r = await api.fetch(`/api/groups/${current.group_id}/leave`, { method:'DELETE' });
        if(r.ok){ await loadGroups(); }
        else alert('Failed to leave group');
      }catch(_){ alert('Failed to leave group'); }
      dom.leave.disabled = false;
    });

    async function autoJoinFromQuery(){
      const params = new URLSearchParams(location.search);
      const code = (params.get('code') || '').trim();
      if (!code) return false;

      try {
        const r = await api.fetch('/api/groups/join', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ code })
        });
        if (r.ok) {
          alert('Joined the group!');
          params.delete('code');
          const q = params.toString();
          history.replaceState({}, '', location.pathname + (q ? `?${q}` : ''));
          return true;
        } else {
          let j = {};
          try { j = await r.json(); } catch(_){}
          const jc = document.getElementById('joinCode');
          if (jc) jc.value = code;
          alert('Could not join: ' + (j.error || r.status));
        }
      } catch(_){}
      return false;
    }

    (async function boot(){
      await autoJoinFromQuery();
      await loadGroups();
    })();
  </script>
</body>
</html>
